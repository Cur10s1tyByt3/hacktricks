# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Informaci√≥n B√°sica

El **Protocolo de Tiempo de Red (NTP)** asegura que las computadoras y dispositivos de red en redes de latencia variable sincronicen sus relojes con precisi√≥n. Es vital para mantener una cronometraje preciso en las operaciones de TI, seguridad y registro. Debido a que el tiempo se utiliza en casi todos los procesos de autenticaci√≥n, criptoprotocolos y forenses, **un atacante que puede influir en NTP a menudo puede eludir controles de seguridad o dificultar la investigaci√≥n de ataques.**

### Resumen y Consejos de Seguridad

- **Prop√≥sito**: Sincroniza los relojes de los dispositivos a trav√©s de redes.
- **Importancia**: Cr√≠tico para la seguridad, el registro, los criptoprotocolos y los sistemas distribuidos.
- **Medidas de Seguridad**:
- Utilizar fuentes de NTP o NTS (Seguridad de Tiempo de Red) de confianza con autenticaci√≥n.
- Restringir qui√©n puede consultar/ordenar al demonio (``restrict default noquery``, ``kod`` etc.).
- Deshabilitar consultas de control de modo 6/7 heredadas (``monlist``, ``ntpdc``) o limitarlas en tasa.
- Monitorear la deriva de sincronizaci√≥n/estado de segundo intercalar para detectar manipulaciones.
- Mantener el demonio actualizado (ver CVEs recientes a continuaci√≥n).

**Puertos predeterminados**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) ‚Äì TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Enumeraci√≥n

### ntpd / ntpq / ntpdc cl√°sico
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (en la mayor√≠a de las distribuciones modernas de Linux)

Solo un pu√±ado de comandos de monitoreo son aceptados desde IPs remotas cuando ``cmdallow`` est√° habilitado:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Consulte la p√°gina del manual de chronyc para el significado de las banderas **M/S** y otros campos (estrato, alcance, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Escaneo masivo/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examinar archivos de configuraci√≥n

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd ‚Äì solo cliente)

Presta especial atenci√≥n a las l√≠neas ``restrict``, configuraciones ``kod`` (Kiss-o'-Death), ``disable monitor``/``includefile /etc/ntp/crypto`` y si *NTS* est√° habilitado (``nts enable``).

---
## Vulnerabilidades recientes (2023-2025)

| A√±o | CVE | Componente | Impacto |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551‚Üí26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | M√∫ltiples escrituras fuera de l√≠mites accesibles a trav√©s de respuestas de **ntpq**. Parche en **4.2.8p16** ü°í actualizar o retroceder correcciones. |
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implementaci√≥n en Rust) | Cookie **NTS** malformada causa **DoS** remoto antes de v0.3.3 ‚Äì afecta al puerto 123 incluso cuando NTS est√° **deshabilitado**. |
| 2024 | actualizaciones de distro | **chrony 4.4 / 4.5** ‚Äì varias correcciones de seguridad y NTS-KE (por ejemplo, SUSE-RU-2024:2022) |
| 2024 | DDoS r√©cord | Cloudflare informa de un ataque de **reflejo UDP de 5.6 Tbps** (NTP entre los protocolos utilizados). Mantener *monitor* y *monlist* deshabilitados en hosts expuestos a Internet. |

> **Kits de explotaci√≥n**: Cargas √∫tiles de prueba de concepto para la serie de escritura OOB de ntpq de 2023 est√°n en GitHub (ver el informe de Meinberg) y pueden ser armadas para phishing del lado del cliente de administradores de sistemas.

---
## Ataques avanzados

### 1. Amplificaci√≥n / Reflexi√≥n NTP

La consulta de modo 7 ``monlist`` devuelve hasta **600 direcciones de host** y todav√≠a est√° presente en miles de hosts de Internet. Debido a que la respuesta (428-468 bytes/entrada) es *~ 200√ó* m√°s grande que la solicitud de 8 bytes, un atacante puede alcanzar factores de amplificaci√≥n de tres d√≠gitos. Mitigaciones:

- Actualizar a ntp 4.2.8p15+ y **agregar** ``disable monitor``.
- Limitar la tasa de UDP/123 en el borde o habilitar *sessions-required* en dispositivos DDoS.
- Habilitar filtrado de egreso *BCP 38* para bloquear el spoofing de origen.

Consulta el art√≠culo del centro de aprendizaje de Cloudflare para un desglose paso a paso.

### 2. Ataques de desplazamiento / retraso de tiempo (investigaci√≥n de Khronos / Chronos)

Incluso con autenticaci√≥n, un atacante en la ruta puede **desplazar silenciosamente el reloj del cliente** al soltar/retrasar paquetes. El borrador **Khronos (anteriormente Chronos)** de la IETF propone consultar un conjunto diverso de servidores en segundo plano y verificar la cordura del resultado para detectar un desplazamiento > ùö° ms. Chrony moderno (4.4+) ya implementa un filtro de cordura similar (``maxdistance`` / ``maxjitter``).

### 3. Abuso de NTS y exposici√≥n de 4460/tcp

NTS mueve la criptograf√≠a pesada a un **canal TLS 1.3 separado en 4460/tcp** (``ntske/1``). Implementaciones deficientes (ver CVE-2023-33192) se bloquean al analizar cookies o permiten cifrados d√©biles. Los pentesters deben:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Busca certificados autofirmados o caducados y suites de cifrado d√©biles (no-AEAD). Referencia: RFC 8915 ¬ß4.

---
## Endurecimiento / Mejores Pr√°cticas Actuales (BCP-233 / RFC 8633)

*Los operadores DEBEN:*

1. Usar **‚â• 4** fuentes de tiempo independientes y diversas (piscinas p√∫blicas, GPS, puentes PTP) para evitar la contaminaci√≥n de una √∫nica fuente.
2. Habilitar restricciones ``kod`` y ``limited``/``nomodify`` para que los clientes abusivos reciban paquetes de limitaci√≥n de tasa **Kiss-o'-Death** en lugar de respuestas completas.
3. Monitorear los registros del daemon en busca de eventos de **panic** o ajustes de paso > 1000 s. (Firmas de ataque seg√∫n RFC 8633 ¬ß5.3.)
4. Considerar **leap-smear** para evitar interrupciones por segundos intercalares, pero asegurarse de que *todos* los clientes aguas abajo utilicen la misma ventana de smear.
5. Mantener el sondeo ‚â§24 h para que no se pierdan las banderas de segundos intercalares.

Consulta RFC 8633 para una lista de verificaci√≥n completa.

---
## Shodan / Dorks de Censys
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Herramientas √ötiles

| Herramienta | Prop√≥sito | Ejemplo |
|-------------|-----------|---------|
| ``ntpwn`` | Wrapper de script-kiddie para rociar consultas monlist y peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Escaneo masivo / salida JSON incluyendo la bandera monlist | Ver comando arriba |
| ``chronyd`` con ``allow`` | Ejecutar servidor NTP malicioso en laboratorio de pentesting | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Inyectar paquetes NTP para MITM de desplazamiento de tiempo en Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Comandos Autom√°ticos de HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Referencias

- RFC 8915 ‚Äì *Seguridad de Tiempo de Red para el Protocolo de Tiempo de Red* (puerto 4460)
- RFC 8633 ‚Äì *Protocolo de Tiempo de Red BCP*
- Informe de DDoS de Cloudflare Q4 2024 (5.6 Tbps)
- Art√≠culo de Cloudflare sobre *Ataque de Amplificaci√≥n NTP*
- NTP 4.2.8p15 serie CVE 2023-04
- Entradas de NVD **CVE-2023-26551‚Äì55**, **CVE-2023-33192**
- Actualizaci√≥n de seguridad de SUSE chrony 2024 (chrony 4.5)
- Borrador de Khronos/Chronos (mitigaci√≥n de desplazamiento de tiempo)
- Manual/examples de chronyc para monitoreo remoto
- Documentaci√≥n del m√≥dulo ntp de zgrab2
{{#include ../banners/hacktricks-training.md}}
