# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## InformaciÃ³n BÃ¡sica

El **Protocolo de Tiempo de Red (NTP)** asegura que las computadoras y dispositivos de red en redes de latencia variable sincronicen sus relojes con precisiÃ³n. Es vital para mantener una cronometraje preciso en las operaciones de TI, seguridad y registro. Debido a que el tiempo se utiliza en casi todos los procesos de autenticaciÃ³n, criptoprotocolos y forenses, **un atacante que puede influir en NTP a menudo puede eludir controles de seguridad o dificultar la investigaciÃ³n de ataques.**

### Resumen y Consejos de Seguridad

- **PropÃ³sito**: Sincroniza los relojes de los dispositivos a travÃ©s de redes.
- **Importancia**: CrÃ­tico para la seguridad, el registro, los criptoprotocolos y los sistemas distribuidos.
- **Medidas de Seguridad**:
- Utilizar fuentes de NTP o NTS (Seguridad de Tiempo de Red) de confianza con autenticaciÃ³n.
- Restringir quiÃ©n puede consultar/ordenar al demonio (``restrict default noquery``, ``kod`` etc.).
- Deshabilitar consultas de control de legado Mode-6/7 (``monlist``, ``ntpdc``) o limitarlas por tasa.
- Monitorear la deriva de sincronizaciÃ³n/estado de segundo intercalar para detectar manipulaciones.
- Mantener el demonio actualizado (ver CVEs recientes a continuaciÃ³n).

**Puertos predeterminados**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## EnumeraciÃ³n

### ntpd / ntpq / ntpdc clÃ¡sico
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (en la mayorÃ­a de las distribuciones modernas de Linux)

Solo un puÃ±ado de comandos de monitoreo son aceptados desde IPs remotas cuando ``cmdallow`` estÃ¡ habilitado:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Consulte la pÃ¡gina del manual de chronyc para el significado de las banderas **M/S** y otros campos (estrato, alcance, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Escaneo masivo/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examinar archivos de configuraciÃ³n

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ solo cliente)

Presta especial atenciÃ³n a las lÃ­neas ``restrict``, configuraciones ``kod`` (Kiss-o'-Death), ``disable monitor``/``includefile /etc/ntp/crypto`` y si *NTS* estÃ¡ habilitado (``nts enable``).

---
## Vulnerabilidades recientes (2023-2025)

| AÃ±o | CVE | Componente | Impacto |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | MÃºltiples escrituras fuera de lÃ­mites accesibles a travÃ©s de respuestas de **ntpq**. Parche en **4.2.8p16** ğŸ¡’ actualizar o retroceder correcciones. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implementaciÃ³n en Rust) | Cookie **NTS** malformada causa **DoS** remoto antes de v0.3.3 â€“ afecta al puerto 123 incluso cuando NTS estÃ¡ **deshabilitado**. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | actualizaciones de distro | **chrony 4.4 / 4.5** â€“ varias correcciones de seguridad y NTS-KE (por ejemplo, SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | Registro DDoS | Cloudflare informa de un ataque de **reflejo UDP de 5.6 Tbps** (NTP entre los protocolos utilizados). Mantener *monitor* y *monlist* deshabilitados en hosts expuestos a Internet. îˆ€citeîˆ‚turn5search0îˆ|

> **Kits de explotaciÃ³n**: Cargas Ãºtiles de prueba de concepto para la serie de escritura OOB de ntpq 2023 estÃ¡n en GitHub (ver el informe de Meinberg) y pueden ser armadas para phishing del lado del cliente de administradores de sistemas. îˆ€citeîˆ‚turn1search4îˆ

---
## Ataques avanzados

### 1. AmplificaciÃ³n / ReflexiÃ³n NTP

La consulta de legado Mode-7 ``monlist`` devuelve hasta **600 direcciones de host** y todavÃ­a estÃ¡ presente en miles de hosts de Internet. Debido a que la respuesta (428-468 bytes/entrada) es *~ 200Ã—* mÃ¡s grande que la solicitud de 8 bytes, un atacante puede alcanzar factores de amplificaciÃ³n de tres dÃ­gitos. Mitigaciones:

- Actualizar a ntp 4.2.8p15+ y **agregar** ``disable monitor``.
- Limitar la tasa de UDP/123 en el borde o habilitar *sessions-required* en dispositivos DDoS.
- Habilitar filtrado de egreso *BCP 38* para bloquear el spoofing de origen.

Consulta el artÃ­culo del centro de aprendizaje de Cloudflare para un desglose paso a paso. îˆ€citeîˆ‚turn5search1îˆ

### 2. Ataques de desplazamiento / retraso de tiempo (investigaciÃ³n de Khronos / Chronos)

Incluso con autenticaciÃ³n, un atacante en el camino puede **desplazar silenciosamente el reloj del cliente** al soltar/retrasar paquetes. El borrador **Khronos (anteriormente Chronos)** de la IETF propone consultar un conjunto diverso de servidores en segundo plano y verificar la cordura del resultado para detectar un desplazamiento > ğš¡ ms. Chrony moderno (4.4+) ya implementa un filtro de cordura similar (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. Abuso de NTS y exposiciÃ³n de 4460/tcp

NTS mueve la criptografÃ­a pesada a un **canal TLS 1.3 separado en 4460/tcp** (``ntske/1``). Implementaciones deficientes (ver CVE-2023-33192) se bloquean al analizar cookies o permiten cifrados dÃ©biles. Los pentesters deben:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Busca certificados autofirmados o caducados y suites de cifrado dÃ©biles (no-AEAD). Referencia: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Endurecimiento / Mejores PrÃ¡cticas Actuales (BCP-233 / RFC 8633)

*Los operadores DEBEN:*

1. Usar **â‰¥ 4** fuentes de tiempo independientes y diversas (piscinas pÃºblicas, GPS, puentes PTP) para evitar la contaminaciÃ³n de una Ãºnica fuente.
2. Habilitar restricciones ``kod`` y ``limited``/``nomodify`` para que los clientes abusivos reciban paquetes de limitaciÃ³n de tasa **Kiss-o'-Death** en lugar de respuestas completas.
3. Monitorear los registros del daemon en busca de eventos **panic** o ajustes de paso > 1000 s. (Firmas de ataque segÃºn RFC 8633 Â§5.3.)
4. Considerar **leap-smear** para evitar interrupciones por segundos intercalares, pero asegurarse de que *todos* los clientes aguas abajo utilicen la misma ventana de smear.
5. Mantener el sondeo â‰¤24 h para que no se pierdan las banderas de segundos intercalares.

Consulte RFC 8633 para una lista de verificaciÃ³n completa. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Dorks de Censys
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Herramientas Ãštiles

| Herramienta | PropÃ³sito | Ejemplo |
|-------------|-----------|---------|
| ``ntpwn`` | Wrapper de script-kiddie para rociar consultas monlist y peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Escaneo masivo / salida JSON incluyendo la bandera monlist | Ver comando arriba |
| ``chronyd`` con ``allow`` | Ejecutar servidor NTP malicioso en laboratorio de pentest | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Inyectar paquetes NTP para MITM de desplazamiento de tiempo en Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Comandos AutomÃ¡ticos de HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Referencias

- RFC 8915 â€“ *Seguridad de Tiempo de Red para el Protocolo de Tiempo de Red* (puerto 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *Protocolo de Tiempo de Red BCP* îˆ€citeîˆ‚turn8search0îˆ
- Informe de DDoS de Cloudflare Q4 2024 (5.6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- ArtÃ­culo de Cloudflare sobre *Ataque de AmplificaciÃ³n NTP* îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 serie CVE 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- Entradas de NVD **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- ActualizaciÃ³n de seguridad de SUSE chrony 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Borrador de Khronos/Chronos (mitigaciÃ³n de desplazamiento de tiempo) îˆ€citeîˆ‚turn9search1îˆ
- Manual/examples de chronyc para monitoreo remoto îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- DocumentaciÃ³n del mÃ³dulo ntp de zgrab2 îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
