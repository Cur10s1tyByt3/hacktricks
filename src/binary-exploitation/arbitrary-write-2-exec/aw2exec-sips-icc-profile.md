# WWW2Exec - sips ICC Profile Out-of-Bounds Write (CVE-2024-44236)

{{#include ../../banners/hacktricks-training.md}}

## Overview

Una vulnerabilidad de escritura fuera de límites en el analizador de perfiles ICC del Sistema de Procesamiento de Imágenes Scriptable de Apple macOS (`sips`) (macOS 15.0.1, sips-307) debido a una validación inadecuada del campo `offsetToCLUT` en las etiquetas `lutAToBType` (`mAB `) y `lutBToAType` (`mBA `). Un archivo ICC manipulado puede provocar escrituras cero de hasta 16 bytes más allá del búfer de la pila, corrompiendo los metadatos de la pila o punteros de función y habilitando la ejecución de código arbitrario (CVE-2024-44236).

## Vulnerable Code

La función vulnerable lee y pone a cero 16 bytes comenzando desde un desplazamiento controlado por el atacante sin asegurarse de que esté dentro del búfer asignado:
```c
// Pseudocode from sub_1000194D0 in sips-307 (macOS 15.0.1)
for (i = offsetToCLUT; i < offsetToCLUT + 16; i++) {
if (i > numberOfInputChannels && buffer[i] != 0)
buffer[i] = 0;
}
```
Solo se realiza una verificación `offsetToCLUT <= totalDataLength`. Al establecer `offsetToCLUT == tagDataSize`, el bucle indexa hasta 16 bytes más allá del final de `buffer`, corrompiendo los metadatos adyacentes del heap.

## Pasos de Explotación

1. **Crear un perfil `.icc` malicioso:**
- Construir el encabezado ICC (128 bytes) con la firma `acsp` y una única entrada de etiqueta `lutAToBType` o `lutBToAType`.
- En la tabla de etiquetas, establecer `offsetToCLUT` igual al `size` de la etiqueta (`tagDataSize`).
- Colocar datos controlados por el atacante inmediatamente después del bloque de datos de la etiqueta para sobrescribir los metadatos del heap.
2. **Activar el análisis:**

```bash
sips --verifyColor malicious.icc
```

3. **Corrupción de metadatos del heap:** Las escrituras cero OOB sobrescriben los metadatos del asignador o punteros adyacentes, permitiendo al atacante secuestrar el flujo de control y lograr la ejecución arbitraria de código en el contexto del proceso `sips`.

## Impacto

La explotación exitosa resulta en la ejecución remota de código arbitrario con privilegios de usuario en sistemas macOS que ejecutan la utilidad `sips` vulnerable.

## Detección

- Monitorear transferencias de archivos en protocolos comunes (FTP, HTTP/S, IMAP, SMB, NFS, SMTP).
- Inspeccionar archivos transferidos con la firma `acsp`.
- Para cada etiqueta `mAB ` o `mBA `, verificar si el campo `Offset to CLUT` es igual al `Tag data size`.
- Marcar como sospechoso si se cumple esta condición.

## Referencias

- Blog de ZDI: CVE-2024-44236: Vulnerabilidad de Ejecución Remota de Código en la Utilidad sips de Apple macOS
https://www.thezdi.com/blog/2025/5/7/cve-2024-44236-remote-code-execution-vulnerability-in-apple-macos
- Actualización de Seguridad de Apple de octubre de 2024 (parche que envía CVE-2024-44236)
https://support.apple.com/en-us/121564

{{#include ../../banners/hacktricks-training.md}}
