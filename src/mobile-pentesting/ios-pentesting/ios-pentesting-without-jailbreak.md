# iOS Pentesting without Jailbreak

{{#include ../../banners/hacktricks-training.md}}

## Idea principal

Las aplicaciones firmadas con el **derecho `get_task_allow`** permiten que aplicaciones de terceros ejecuten una función llamada **`task_for_pid()`** con el ID de proceso de la aplicación inicial como argumento para obtener el puerto de tarea sobre ella (poder controlarla y acceder a su memoria).

Sin embargo, no es tan fácil como simplemente extraer el IPA, volver a firmarlo con el derecho y cargarlo de nuevo en tu dispositivo. Esto se debe a la protección FairPlay. Cuando la firma de la aplicación cambia, la clave DRM (Gestión de Derechos Digitales) es **invalidada y la aplicación no funcionará**.

Con un dispositivo antiguo con jailbreak, es posible instalar el IPA, **desencriptarlo usando tu herramienta favorita** (como Iridium o frida-ios-dump) y extraerlo del dispositivo. Aunque, si es posible, se recomienda pedir al cliente el IPA desencriptado.

## Obtener IPA desencriptado

### Obtenerlo de Apple

1. Instala la aplicación a pentest en el iPhone.
2. Instala y lanza [Apple Configurator](https://apps.apple.com/au/app/apple-configurator/id1037126344?mt=12) en tu macos.
3. Abre `Terminal` en tu Mac y navega a `/Users/[username]/Library/Group\\ Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps`. El IPA aparecerá en esta carpeta más tarde.
4. Deberías ver tu dispositivo iOS. Haz doble clic en él y luego haz clic en Agregar + → Aplicaciones en la barra de menú superior.
5. Después de hacer clic en Agregar, Configurator descargará el IPA de Apple e intentará enviarlo a tu dispositivo. Si seguiste mi recomendación anterior e instalaste el IPA ya, aparecerá un aviso pidiéndote que reinstales la aplicación.
6. El IPA debería descargarse dentro de `/Users/[username]/Library/Group\\ Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps` desde donde puedes obtenerlo.

Consulta [https://dvuln.com/blog/modern-ios-pentesting-no-jailbreak-needed](https://dvuln.com/blog/modern-ios-pentesting-no-jailbreak-needed) para obtener información más detallada sobre este proceso.

### Desencriptar la aplicación

Para desencriptar el IPA, vamos a instalarlo. Sin embargo, si tienes un iPhone antiguo con jailbreak, potencialmente su versión no será compatible con la aplicación, ya que generalmente las aplicaciones solo soportan las versiones más recientes.

Así que, para instalarlo, simplemente descomprime el IPA:
```bash
unzip redacted.ipa -d unzipped
```
Verifica el `Info.plist` para la versión mínima soportada y si tu dispositivo es más antiguo que eso, cambia el valor para que sea compatible.

Comprime de nuevo el IPA:
```bash
cd unzipped
zip -r ../no-min-version.ipa *
```
Luego, instala el IPA por ejemplo con:
```bash
ideviceinstaller -i no-min-version.ipa -w
```
Nota que podrías necesitar **AppSync Unified tweak** de Cydia para prevenir cualquier error de `invalid signature`.

Una vez instalado, puedes usar **Iridium tweak** de Cydia para obtener el IPA descifrado.


### Parchear derechos y re-firmar

Para re-firmar la aplicación con el derecho `get-task-allow`, hay varias herramientas disponibles como `app-signer`, `codesign` e `iResign`. `app-signer` tiene una interfaz muy amigable que permite re-firmar un archivo IPA de manera muy sencilla indicando el IPA a re-firmar, **ponerlo en `get-task-allow`** y el certificado y perfil de aprovisionamiento a utilizar.

En cuanto al certificado y los perfiles de firma, Apple ofrece **perfiles de firma de desarrollador gratuitos** para todas las cuentas a través de Xcode. Solo crea una aplicación y configura uno. Luego, configura el **iPhone para confiar en las aplicaciones de desarrollador** navegando a `Settings` → `Privacy & Security`, y haz clic en `Developer Mode`.

Con el IPA re-firmado, es hora de instalarlo en el dispositivo para realizar el pentesting:
```bash
ideviceinstaller -i resigned.ipa -w
```
---

### Habilitar el Modo Desarrollador (iOS 16+)

Desde iOS 16, Apple introdujo el **Modo Desarrollador**: cualquier binario que lleve `get_task_allow` *o* esté firmado con un certificado de desarrollo se negará a lanzarse hasta que el Modo Desarrollador esté habilitado en el dispositivo. También no podrás adjuntar Frida/LLDB a menos que esta opción esté activada.

1. Instala o envía **cualquier** IPA firmada por un desarrollador al teléfono.
2. Navega a **Configuración → Privacidad y Seguridad → Modo Desarrollador** y actívalo.
3. El dispositivo se reiniciará; después de ingresar el código de acceso, se te pedirá que **Actives** el Modo Desarrollador.

El Modo Desarrollador permanece activo hasta que lo desactives o restaures el teléfono, por lo que este paso solo necesita realizarse una vez por dispositivo. La [documentación de Apple](https://developer.apple.com/documentation/xcode/enabling-developer-mode-on-a-device) explica las implicaciones de seguridad.

### Opciones modernas de sideloading

Ahora hay varias formas maduras de sideload y mantener las IPAs re-firmadas actualizadas sin un jailbreak:

| Herramienta | Requisitos | Fortalezas | Limitaciones |
|-------------|------------|------------|--------------|
| **AltStore 2 / SideStore** | Compañero de macOS/Windows/Linux que re-firma la IPA cada 7 días con un perfil de desarrollador gratuito | Recarga automática por Wi-Fi, funciona hasta iOS 17 | Necesita computadora en la misma red, límite de 3 aplicaciones impuesto por Apple |
| **TrollStore 1/2** | Dispositivo en iOS 14 – 15.4.1 vulnerable al bug de CoreTrust | Firma *permanente* (sin límite de 7 días); no se requiere computadora una vez instalado | No es compatible con iOS 15.5+ (bug corregido) |

Para pruebas de pentesting rutinarias en versiones actuales de iOS, Alt/Side-Store suelen ser la opción más práctica.

### Hooking / instrumentación dinámica

Puedes enganchar tu aplicación exactamente como en un dispositivo con jailbreak una vez que esté firmada con `get_task_allow` **y** el Modo Desarrollador esté activado:
```bash
# Spawn & attach with objection
objection -g "com.example.target" explore

# Or plain Frida
frida -U -f com.example.target -l my_script.js --no-pause
```
Las versiones recientes de Frida (>=16) manejan automáticamente la autenticación de punteros y otras mitigaciones de iOS 17, por lo que la mayoría de los scripts existentes funcionan sin problemas.

### Análisis dinámico automatizado con MobSF (sin jailbreak)

[MobSF](https://mobsf.github.io/Mobile-Security-Framework-MobSF/) puede instrumentar un IPA firmado por el desarrollador en un dispositivo real utilizando la misma técnica (`get_task_allow`) y proporciona una interfaz web con navegador de sistema de archivos, captura de tráfico y consola de Frida【†L2-L3】. La forma más rápida es ejecutar MobSF en Docker y luego conectar tu iPhone a través de USB:
```bash
docker pull opensecurity/mobile-security-framework-mobsf:latest
docker run -p 8000:8000 --privileged \
-v /var/run/usbmuxd:/var/run/usbmuxd \
opensecurity/mobile-security-framework-mobsf:latest
# Browse to http://127.0.0.1:8000 and upload your resigned IPA
```
MobSF desplegará automáticamente el binario, habilitará un servidor Frida dentro del sandbox de la aplicación y generará un informe interactivo.

### iOS 17 y advertencias del Modo de Bloqueo

* **Modo de Bloqueo** (Configuración → Privacidad y Seguridad) bloquea al enlazador dinámico de cargar bibliotecas dinámicas no firmadas o firmadas externamente. Al probar dispositivos que podrían tener este modo habilitado, asegúrate de que esté **deshabilitado** o tus sesiones de Frida/objection se terminarán inmediatamente.
* La Autenticación de Punteros (PAC) se aplica a nivel del sistema en dispositivos A12+. Frida ≥16 maneja de manera transparente la eliminación de PAC; solo mantén tanto *frida-server* como la herramienta de Python/CLI actualizados cuando se lance una nueva versión importante de iOS.

## Referencias

- [https://dvuln.com/blog/modern-ios-pentesting-no-jailbreak-needed](https://dvuln.com/blog/modern-ios-pentesting-no-jailbreak-needed)
- Documentación para desarrolladores de Apple – Habilitar el Modo de Desarrollador en un dispositivo: <https://developer.apple.com/documentation/xcode/enabling-developer-mode-on-a-device>
- Mobile Security Framework (MobSF): <https://mobsf.github.io/Mobile-Security-Framework-MobSF/>

{{#include ../../banners/hacktricks-training.md}}
