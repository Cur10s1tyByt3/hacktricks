# iOS Universal Links

{{#include ../../banners/hacktricks-training.md}}

## Introducción

Los enlaces universales ofrecen una **experiencia de redirección** fluida a los usuarios al abrir directamente el contenido en la aplicación, evitando la necesidad de redirección a Safari. Estos enlaces son **únicos** y seguros, ya que no pueden ser reclamados por otras aplicaciones. Esto se asegura al alojar un archivo JSON `apple-app-site-association` en el directorio raíz del sitio web, estableciendo un enlace verificable entre el sitio web y la aplicación. En casos donde la aplicación no está instalada, Safari tomará el control y dirigirá al usuario a la página web, manteniendo la presencia de la aplicación.

Para los testers de penetración, el archivo `apple-app-site-association` es de particular interés ya que puede revelar **rutas sensibles**, potencialmente incluyendo aquellas relacionadas con características no lanzadas.

### **Analizando el Derecho de Dominios Asociados**

Los desarrolladores habilitan los Enlaces Universales configurando los **Dominios Asociados** en la pestaña de Capacidades de Xcode o inspeccionando el archivo `.entitlements`. Cada dominio está precedido por `applinks:`. Por ejemplo, la configuración de Telegram podría aparecer de la siguiente manera:
```xml
<key>com.apple.developer.associated-domains</key>
<array>
<string>applinks:telegram.me</string>
<string>applinks:t.me</string>
</array>
```
Para obtener información más completa, consulta la [documentación de desarrolladores de Apple archivada](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2).

Si trabajas con una aplicación compilada, los derechos pueden ser extraídos como se detalla en [esta guía](extracting-entitlements-from-compiled-application.md).

### **Recuperando el archivo de asociación de sitios de aplicaciones de Apple**

El archivo `apple-app-site-association` debe ser recuperado del servidor utilizando los dominios especificados en los derechos. Asegúrate de que el archivo sea accesible a través de HTTPS directamente en `https://<domain>/apple-app-site-association` (o `/.well-known/apple-app-site-association`). Herramientas como el [validador de AASA de Apple](https://branch.io/resources/aasa-validator/) pueden ayudar en este proceso.

> **Enumeración rápida desde un shell de macOS/Linux**
>
> ```bash
> # asumiendo que has extraído los derechos a ent.xml
> doms=$(plutil -extract com.apple.developer.associated-domains xml1 -o - ent.xml | \
>        grep -oE 'applinks:[^<]+' | cut -d':' -f2)
> for d in $doms; do
>   echo "[+] Recuperando AASA para $d";
>   curl -sk "https://$d/.well-known/apple-app-site-association" | jq '.'
> done
> ```

### **Manejando enlaces universales en la aplicación**

La aplicación debe implementar métodos específicos para manejar enlaces universales correctamente. El método principal a buscar es [`application:continueUserActivity:restorationHandler:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application). Es crucial que el esquema de las URL manejadas sea HTTP o HTTPS, ya que otros no serán soportados.

#### **Validando el método del manejador de datos**

Cuando un enlace universal abre una aplicación, se pasa un objeto `NSUserActivity` a la aplicación con la URL. Antes de procesar esta URL, es esencial validarla y sanitizarla para prevenir riesgos de seguridad. Aquí hay un ejemplo en Swift que demuestra el proceso:
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity,
restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
// Check for web browsing activity and valid URL
if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
application.open(url, options: [:], completionHandler: nil)
}

return true
}
```
Las URLs deben ser analizadas y validadas cuidadosamente, especialmente si incluyen parámetros, para protegerse contra posibles suplantaciones o datos mal formados. La API `NSURLComponents` es útil para este propósito, como se demuestra a continuación:
```swift
func application(_ application: UIApplication,
continue userActivity: NSUserActivity,
restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
let incomingURL = userActivity.webpageURL,
let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
let path = components.path,
let params = components.queryItems else {
return false
}

if let albumName = params.first(where: { $0.name == "albumname" })?.value,
let photoIndex = params.first(where: { $0.name == "index" })?.value {
// Process the URL with album name and photo index

return true

} else {
// Handle invalid or missing parameters

return false
}
}
```
A través de **una configuración y validación diligentes**, los desarrolladores pueden asegurarse de que los enlaces universales mejoren la experiencia del usuario mientras mantienen los estándares de seguridad y privacidad.

## Vulnerabilidades Comunes y Comprobaciones de Pentesting

| # | Debilidad | Cómo probar | Explotación / Impacto |
|---|----------|------------|-----------------------|
| 1 | **`paths` / `components` demasiado amplios** en el archivo AASA (por ejemplo, `"/": "*"` o comodines como `"/a/*"`). | • Inspeccionar el AASA descargado y buscar `*`, barras finales o reglas `{"?": …}`.<br>• Intentar solicitar recursos desconocidos que aún coincidan con la regla (`https://domain.com/a/evil?_p_dp=1`). | Secuestro de enlaces universales: una aplicación maliciosa de iOS que registre el mismo dominio podría reclamar todos esos enlaces y presentar una interfaz de phishing. Un ejemplo del mundo real es el informe de recompensas por errores de Temu.com de mayo de 2025, donde un atacante podría redirigir cualquier ruta `/a/*` a su propia aplicación. |
| 2 | **Falta de validación del lado del servidor** de las rutas de enlaces profundos. | Después de identificar las rutas permitidas, emitir solicitudes `curl`/Burp a recursos no existentes y observar los códigos de estado HTTP. Cualquier cosa diferente de `404` (por ejemplo, 200/302) es sospechosa. | Un atacante puede alojar contenido arbitrario detrás de una ruta permitida y servirlo a través del dominio legítimo, aumentando la tasa de éxito del phishing o el robo de tokens de sesión. |
| 3 | **Manejo de URL del lado de la aplicación sin lista blanca de esquema/host** (CVE-2024-10474 – Mozilla Focus < 132). | Buscar llamadas directas a `openURL:`/`open(_:options:)` o puentes de JavaScript que reenvíen URLs arbitrarias. | Las páginas internas pueden ocultar URLs `myapp://` o `https://` que eluden las comprobaciones de seguridad de la barra de URL del navegador, lo que lleva a suplantaciones o acciones privilegiadas no intencionadas. |
| 4 | **Uso de subdominios comodín** (`*.example.com`) en el derecho. | `grep` para `*.` en los derechos. | Si se toma cualquier subdominio (por ejemplo, a través de un bucket S3 no utilizado), el atacante obtiene automáticamente el enlace de Universal Link. |

### Lista de Verificación Rápida

* [ ] Extraer derechos y enumerar cada entrada `applinks:`.
* [ ] Descargar AASA para cada entrada y auditar en busca de comodines.
* [ ] Verificar que el servidor web devuelva **404** para rutas no definidas.
* [ ] En el binario, confirmar que **solo** se manejan hosts/esquemas de confianza.
* [ ] Si la aplicación utiliza la nueva sintaxis de `components` (iOS 11+), probar reglas de parámetros de consulta (`{"?":{…}}`).

## Herramientas

- [GetUniversal.link](https://getuniversal.link/): Ayuda a simplificar la prueba y gestión de los Enlaces Universales de tu aplicación y el archivo AASA. Simplemente ingresa tu dominio para verificar la integridad del archivo AASA o utiliza el panel personalizado para probar fácilmente el comportamiento de los enlaces. Esta herramienta también te ayuda a determinar cuándo Apple indexará tu archivo AASA a continuación.
- [Knil](https://github.com/ethanhuang13/knil): Utilidad de iOS de código abierto que obtiene, analiza y te permite **probar** cada Enlace Universal declarado por un dominio directamente en el dispositivo.
- [universal-link-validator](https://github.com/urbangems/universal-link-validator): Validador CLI / web que realiza comprobaciones estrictas de conformidad AASA y resalta comodines peligrosos.

## Referencias

- [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis)
- [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8)
- [https://medium.com/@m.habibgpi/universal-link-hijacking-via-misconfigured-aasa-file-on-temu-com-eadfcb745e4e](https://medium.com/@m.habibgpi/universal-link-hijacking-via-misconfigured-aasa-file-on-temu-com-eadfcb745e4e)
- [https://nvd.nist.gov/vuln/detail/CVE-2024-10474](https://nvd.nist.gov/vuln/detail/CVE-2024-10474)

{{#include ../../banners/hacktricks-training.md}}
